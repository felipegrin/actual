import{j as e,r as u,K as mt,a5 as Xe,z as Pn,U as ze,bQ as Yt,V as j,aB as En,bR as Fn,t as w,s as ce,bS as xt,bT as Xt,b9 as yt,ba as wt,aw as X,bU as bt,v as je,M as me,bV as St,bW as _e,bX as vt,bY as Je,Z as Ce,bZ as et,aN as Jt,T as ee,b_ as _t,am as De,b$ as en,c0 as _n,c1 as Ln,O as Nn,c2 as Hn,c3 as Un,X as jt,c4 as Lt,c5 as On,c6 as Nt,k as Wn,c7 as $n,as as se,c8 as Gn,c9 as Qn,ca as zn,cb as Vn,cc as qn,cd as Zn,ce as Kn,cf as Yn,cg as Xn,ch as Jn,ci as es,cj as ts,ck as ns,cl as ss,cm as as,cn as os,co as is,G as rs,ag as Ne,n as tn,ai as Re,cp as cs,b7 as ft,y as Y,cq as ls,b8 as ds,cr as us,cs as hs,ct as fs,bc as Ht,be as ps,bh as gs,b4 as Pe,bi as Ut,bl as ms,bf as xs,bg as Ot,bd as ys,bj as ws,bk as bs,al as Ss,cu as nn,cv as vs,at as js,cw as sn,cx as Cs,cy as Ts,aE as Wt,bm as Ee,cz as an,cA as on,cB as Qe,cC as rn,cD as ks,cE as Ge,cF as Ct,cG as $t,cH as Tt,bJ as Me,cI as re,cJ as As,cK as Fe,cL as kt,cM as Bs,cN as cn,cO as ln,J as At,cP as Rs,cQ as Is,cR as Gt,cS as Ms,_ as Ie,m as Ds,l as dn,cT as Ps,cU as Es,cV as Fs,cW as Bt,cX as _s,a1 as Ls,cY as Ns,i as tt,cZ as nt,c_ as Hs,c$ as Us,d0 as Os,aj as Qt,d1 as Ws,d2 as un,d3 as $s,d4 as Gs,d5 as Qs,d6 as zt,$ as zs,d7 as hn,d8 as Vs,d9 as qs,da as fn,H as ot,aK as st,aL as Zs,aM as Ks,w as Rt,bP as pn,ap as Ys,ak as lt,db as Xs,dc as Js,aX as ea,a$ as Le,q as we,aU as It,L as ta,dd as na,bn as sa,I as gn,de as aa,df as mn,dg as oa,br as ia,A as ra,bN as ca,ar as la,Y as da,ah as ua,bq as ha,bz as fa,dh as pa,bw as ga,by as ma,di as xa,x as ge,bA as ya,bB as wa,dj as ba,bF as Sa,dk as xn,dl as va,dm as ja,dn as Ca,dp as Vt,dq as Ta,dr as ka}from"./index.D3b5Q86n.js";import{u as Aa}from"./usePreviewTransactions.fBVa-E_f.chunk.js";import{A as Ba,F as Ra,M as qt}from"./AppliedFilters.afd4eJb4.chunk.js";const Ia=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 91 51",style:{color:"inherit",...n.style},children:e.jsx("path",{fill:"currentColor",d:"M30.256 48.614a3.14 3.14 0 0 0-.989-2.153L10.803 29.063h76.915a3.2 3.2 0 0 0 .315 0c1.584-.084 2.95-1.64 2.867-3.266-.082-1.625-1.598-3.028-3.182-2.943H10.803L29.267 5.49c1.284-1.099 1.456-3.057.385-4.373a2.972 2.972 0 0 0-4.48-.187L.971 23.695a3.163 3.163 0 0 0 0 4.56l24.2 22.766a2.98 2.98 0 0 0 2.205.84c1.669-.08 2.958-1.534 2.88-3.247Z"})}),Ma=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",style:{color:"inherit",...n.style},children:e.jsx("path",{d:"m9 16.172-6.071-6.071-1.414 1.414L10 20l.707-.707 7.778-7.778-1.414-1.414L11 16.172V0H9z",fill:"currentColor"})}),Da=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",style:{color:"inherit",...n.style},children:e.jsx("path",{d:"M9 3.828 2.929 9.899 1.515 8.485 10 0l.707.707 7.778 7.778-1.414 1.414L11 3.828V20H9V3.828z",fill:"currentColor"})}),Pa=n=>e.jsxs("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:[e.jsx("path",{d:"M13.584 12a2.643 2.643 0 0 1-.775 1.875l-9.541 9.541a1.768 1.768 0 0 1-2.5-2.5l8.739-8.739a.25.25 0 0 0 0-.354L.768 3.084a1.768 1.768 0 0 1 2.5-2.5l9.541 9.541A2.643 2.643 0 0 1 13.584 12Z",fill:"currentColor"}),e.jsx("path",{d:"M23.75 12a2.643 2.643 0 0 1-.775 1.875l-9.541 9.541a1.768 1.768 0 0 1-2.5-2.5l8.739-8.739a.25.25 0 0 0 0-.354l-8.739-8.739a1.768 1.768 0 0 1 2.5-2.5l9.541 9.541A2.643 2.643 0 0 1 23.75 12Z",fill:"currentColor"})]}),Ea=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:e.jsx("path",{fill:"currentColor",d:"M19.611 2.571h-3.754a1.286 1.286 0 1 1 0-2.571h6.857A1.286 1.286 0 0 1 24 1.286v6.857a1.286 1.286 0 0 1-2.571 0V4.39L15.48 10.34a1.286 1.286 0 0 1-1.817-1.817l5.948-5.95ZM1.286 14.571a1.286 1.286 0 0 1 1.285 1.286v3.754l5.949-5.946a1.286 1.286 0 0 1 1.817 1.817L4.39 21.429h3.753a1.285 1.285 0 1 1 0 2.571H1.286A1.286 1.286 0 0 1 0 22.714v-6.857a1.286 1.286 0 0 1 1.286-1.286Z"})}),Fa=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:e.jsx("path",{fill:"currentColor",d:"M14.143 1.714A1.286 1.286 0 0 1 15.429 3v3.753L21.806.377a1.286 1.286 0 0 1 1.817 1.817l-6.376 6.377H21a1.286 1.286 0 1 1 0 2.572h-6.857a1.286 1.286 0 0 1-1.286-1.286V3a1.286 1.286 0 0 1 1.286-1.286ZM9.857 22.286A1.285 1.285 0 0 1 8.571 21v-3.753l-6.377 6.376a1.286 1.286 0 0 1-1.817-1.817l6.376-6.377H3a1.286 1.286 0 0 1 0-2.572h6.857a1.286 1.286 0 0 1 1.286 1.286V21a1.286 1.286 0 0 1-1.286 1.286Z"})}),_a=n=>e.jsxs("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:[e.jsx("path",{d:"M8.616 1.741A1.455 1.455 0 0 1 10.07.287h3.392a1.455 1.455 0 0 1 1.453 1.454v8.228a.25.25 0 0 0 .25.25h2.9a1.138 1.138 0 0 1 .827 2l-6.1 6.1a1.489 1.489 0 0 1-2.056 0l-6.1-6.1a1.137 1.137 0 0 1 .827-2h2.9a.249.249 0 0 0 .25-.25Z",fill:"currentColor"}),e.jsx("path",{d:"M0 19.677a4.039 4.039 0 0 0 4.035 4.035h15.93A4.039 4.039 0 0 0 24 19.677V17.8a1.225 1.225 0 0 0-2.449 0v1.874a1.588 1.588 0 0 1-1.586 1.586H4.035a1.588 1.588 0 0 1-1.586-1.586V17.8A1.225 1.225 0 0 0 0 17.8Z",fill:"currentColor"})]}),La=n=>e.jsxs("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:[e.jsx("path",{d:"M12.406 14.905a1 1 0 0 0-.543 1.307 1 1 0 0 1-.217 1.09l-2.828 2.829a2 2 0 0 1-2.828 0L3.868 18.01a2 2 0 0 1 0-2.829L6.7 12.353a1.013 1.013 0 0 1 1.091-.217 1 1 0 0 0 .763-1.849 3.034 3.034 0 0 0-3.268.652l-2.832 2.828a4.006 4.006 0 0 0 0 5.657l2.122 2.121a4 4 0 0 0 5.656 0l2.829-2.828a3.008 3.008 0 0 0 .651-3.27 1 1 0 0 0-1.306-.542Z",fill:"currentColor"}),e.jsx("path",{d:"M7.757 16.241a1.011 1.011 0 0 0 1.414 0l7.779-7.778a1 1 0 0 0-1.414-1.414l-7.779 7.778a1 1 0 0 0 0 1.414Z",fill:"currentColor"}),e.jsx("path",{d:"m21.546 4.574-2.121-2.121a4.006 4.006 0 0 0-5.657 0l-2.829 2.828a3.006 3.006 0 0 0-.651 3.269 1 1 0 1 0 1.849-.764 1 1 0 0 1 .217-1.086l2.828-2.828a2 2 0 0 1 2.829 0l2.121 2.121a2 2 0 0 1 0 2.829L17.3 11.645a1.015 1.015 0 0 1-1.091.217 1 1 0 0 0-.765 1.849 3.026 3.026 0 0 0 3.27-.651l2.828-2.828a4.007 4.007 0 0 0 .004-5.658Z",fill:"currentColor"})]}),Na=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:e.jsx("path",{d:"M15.067 3.986a.5.5 0 0 0-.354-.148.5.5 0 0 0-.354.147L3.437 14.91a.5.5 0 0 0 0 .707l4.948 4.948a.5.5 0 0 0 .707 0L20.009 9.648a.5.5 0 0 0 0-.706ZM2.43 16.8a.5.5 0 0 0-.489-.127.5.5 0 0 0-.351.364L.084 23.314a.5.5 0 0 0 .133.47.507.507 0 0 0 .47.132l6.272-1.5a.5.5 0 0 0 .237-.84ZM23.2 2.924 21.077.8a2.5 2.5 0 0 0-3.532 0l-1.418 1.417a.5.5 0 0 0 0 .707l4.95 4.949a.5.5 0 0 0 .707 0L23.2 6.454a2.5 2.5 0 0 0 0-3.53Z",fill:"currentColor"})}),Ha=({startMonth:n,numDisplayed:t,monthBounds:s,style:a,onSelect:i})=>{const[r,c]=u.useState(null),[o,l]=u.useState(12),d=mt(),p=n,g=Xe(p,t-1),v=Pn(ze(p,o/2-t/2),Xe(g,o/2-t/2)),x=Math.floor(v.length/2)-Math.floor(t/2),T=x+t-1,[C,h]=u.useState("small"),b=Yt(M=>{h(M.width<=400?"small":"big"),l(Math.min(Math.max(Math.floor(M.width/50),12),24))}),R=[];return e.jsx(j,{style:{flexDirection:"row",alignItems:"center",justifyContent:"space-between",...a},children:e.jsx(j,{innerRef:b,style:{flexDirection:"row",flex:1,alignItems:"center",justifyContent:"center"},children:v.map((M,_)=>{const L=En(M,"MMM"),D=_>=x&&_<=T,$=r+t-1,E=r===null?!1:_>=r&&_<=$,k=d===M,P=Fn(M);let O=!1;R.includes(P)||(R.push(P),O=!0);const H=M>=s.start&&M<=s.end;return e.jsxs(j,{style:{padding:"3px 3px",width:C==="big"?"35px":"20px",textAlign:"center",userSelect:"none",cursor:"default",borderRadius:2,border:"none",...!H&&{textDecoration:"line-through",color:w.pageTextSubdued},...ce.smallText,...D&&{backgroundColor:w.tableBorderHover,color:w.buttonPrimaryText},...(E||D)&&{borderRadius:0,cursor:"pointer"},...r!==null&&!E&&D&&{filter:"brightness(65%)"},...E&&!D&&{backgroundColor:w.buttonBareBackgroundHover},...!E&&!D&&k&&{backgroundColor:w.buttonBareBackgroundHover,filter:"brightness(120%)"},...E&&D&&k&&{filter:"brightness(120%)"},...E&&D&&{backgroundColor:w.tableBorderHover},...(_===x||_===r&&!D)&&{borderTopLeftRadius:2,borderBottomLeftRadius:2},...(_===T||_===$&&!D)&&{borderTopRightRadius:2,borderBottomRightRadius:2},...k&&{fontWeight:"bold"}},onClick:()=>i(M),onMouseEnter:()=>c(_),onMouseLeave:()=>c(null),children:[C==="small"?L[0]:L,O&&e.jsx(j,{style:{position:"absolute",top:-14,left:0,fontSize:10,fontWeight:"bold",color:H?w.pageText:w.pageTextSubdued},children:P})]},M)})})})},yn=u.memo(({startMonth:n,onMonthSelect:t,numMonths:s,monthBounds:a})=>e.jsx(j,{style:{marginLeft:205,flexShrink:0},children:e.jsx(j,{style:{marginRight:5+xt()},children:e.jsx(Ha,{startMonth:n,numDisplayed:s,monthBounds:a,style:{paddingTop:5},onSelect:i=>t(i)})})}));yn.displayName="BudgetPageHeader";function He({component:n,editingMonth:t,args:s,style:a}){const{months:i}=u.useContext(Xt);return i.map((r,c)=>{const o=t===r;return e.jsx(yt.Provider,{value:wt(r),children:e.jsx(j,{style:{flex:1,borderLeft:"1px solid "+w.tableBorder,...a},children:e.jsx(n,{month:r,editing:o,...s})})},c)})}function Mt({innerRef:n,category:t,categoryGroup:s,dragPreview:a,dragging:i,editing:r,style:c,isLast:o,onEditName:l,onSave:d,onDelete:p,onHideNewCategory:g}){const v=t.id==="new",[x,T]=u.useState(!1),C=u.useRef(null),h=e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",userSelect:"none",WebkitUserSelect:"none",opacity:t.hidden||s?.hidden?.33:void 0,backgroundColor:"transparent"},children:[e.jsx("div",{"data-testid":"category-name",style:{textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",minWidth:0},children:t.name}),e.jsxs(j,{style:{flexShrink:0,marginLeft:5},ref:C,children:[e.jsx(X,{variant:"bare",className:"hover-visible",style:{color:"currentColor",padding:3},onPress:()=>T(!0),children:e.jsx(bt,{width:14,height:14,style:{color:"currentColor"}})}),e.jsx(je,{triggerRef:C,placement:"bottom start",isOpen:x,onOpenChange:()=>T(!1),style:{width:200},children:e.jsx(me,{onMenuSelect:b=>{b==="rename"?l(t.id):b==="delete"?p(t.id):b==="toggle-visibility"&&d({...t,hidden:!t.hidden}),T(!1)},items:[{name:"rename",text:"Rename"},!s?.hidden&&{name:"toggle-visibility",text:t.hidden?"Show":"Hide"},{name:"delete",text:"Delete"}]})})]}),e.jsx(j,{style:{flex:1}}),e.jsx(j,{style:{flexShrink:0},children:e.jsx(St,{id:t.id,style:i&&{color:"currentColor"},defaultColor:w.pageTextLight})})]});return e.jsx(j,{innerRef:n,style:{width:300,overflow:"hidden","& .hover-visible":{display:"none"},...!i&&!a&&{"&:hover .hover-visible":{display:"flex"}},...i&&{color:w.formInputTextPlaceholderSelected},...a&&{backgroundColor:w.tableBackground,zIndex:1e4,borderRadius:6,overflow:"hidden"},...c},onKeyDown:b=>{b.key==="Enter"&&(l(null),b.stopPropagation())},children:e.jsx(_e,{value:t.name,formatter:()=>h,width:"flex",exposed:r||v,onUpdate:b=>{v?b===""?g():b!==""&&d({...t,name:b}):b!==t.name&&d({...t,name:b})},onBlur:()=>l(null),style:{paddingLeft:13,...o&&{borderBottomWidth:0}},inputProps:{placeholder:v?"New Category Name":""}})})}function Ua({cat:n,categoryGroup:t,editingCell:s,dragState:a,MonthComponent:i,onEditName:r,onEditMonth:c,onSave:o,onDelete:l,onBudgetAction:d,onShowActivity:p,onDragChange:g,onReorder:v}){let x=a&&a.item===n;a&&a.item.id===n.cat_group&&(x=!0);const{dragRef:T}=vt({type:"category",onDragChange:g,item:n,canDrag:s===null}),{dropRef:C,dropPos:h}=Je({types:"category",id:n.id,onDrop:v});return e.jsxs(Ce,{innerRef:C,collapsed:!0,style:{backgroundColor:w.tableBackground,opacity:n.hidden||t?.hidden?.5:void 0},children:[e.jsx(et,{pos:h,offset:{top:1}}),e.jsxs(j,{style:{flex:1,flexDirection:"row"},children:[e.jsx(Mt,{innerRef:T,category:n,categoryGroup:t,dragPreview:x&&a.preview,dragging:x&&!a.preview,editing:s&&s.cell==="name"&&s.id===n.id,onEditName:r,onSave:o,onDelete:l}),e.jsx(He,{component:i,editingMonth:s&&s.id===n.id&&s.cell,args:{category:n,onEdit:c,onBudgetAction:d,onShowActivity:p}})]})]})}function Dt({group:n,editing:t,collapsed:s,dragPreview:a,innerRef:i,style:r,onEdit:c,onSave:o,onDelete:l,onShowNewCategory:d,onHideNewGroup:p,onToggleCollapse:g}){const v=n.id==="new",[x,T]=u.useState(!1),C=u.useRef(null),h=e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",userSelect:"none",WebkitUserSelect:"none"},onClick:()=>{g(n.id)},children:[!a&&e.jsx(Jt,{width:8,height:8,style:{marginRight:5,marginLeft:5,flexShrink:0,transition:"transform .1s",transform:s?"rotate(-90deg)":""}}),e.jsxs("div",{style:{textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",minWidth:0},children:[a&&e.jsx(ee,{style:{fontWeight:500},children:"Group: "}),n.name]}),!a&&e.jsxs(e.Fragment,{children:[e.jsxs(j,{style:{marginLeft:5,flexShrink:0},ref:C,children:[e.jsx(X,{variant:"bare",className:"hover-visible",onPress:()=>T(!0),style:{padding:3},children:e.jsx(bt,{width:14,height:14})}),e.jsx(je,{triggerRef:C,placement:"bottom start",isOpen:x,onOpenChange:()=>T(!1),style:{width:200},children:e.jsx(me,{onMenuSelect:b=>{b==="rename"?c(n.id):b==="add-category"?d(n.id):b==="delete"?l(n.id):b==="toggle-visibility"&&o({...n,hidden:!n.hidden}),T(!1)},items:[{name:"add-category",text:"Add category"},{name:"rename",text:"Rename"},!n.is_income&&{name:"toggle-visibility",text:n.hidden?"Show":"Hide"},l&&{name:"delete",text:"Delete"}]})})]}),e.jsx(j,{style:{flex:1}}),e.jsx(j,{style:{flexShrink:0},children:e.jsx(St,{id:n.id,style:a&&{color:"currentColor"},defaultColor:w.pageTextLight})})]})]});return e.jsx(j,{innerRef:i,style:{...r,width:300,backgroundColor:w.tableRowHeaderBackground,overflow:"hidden","& .hover-visible":{display:"none"},...!a&&{"&:hover .hover-visible":{display:"flex"}},...a&&{paddingLeft:10,zIndex:1e4,borderRadius:6,overflow:"hidden"}},onKeyDown:b=>{b.key==="Enter"&&(c(null),b.stopPropagation())},children:e.jsx(_e,{value:n.name,formatter:()=>h,width:"flex",exposed:t,onUpdate:b=>{v?b===""?p():b!==""&&o({id:n.id,name:b}):o({id:n.id,name:b})},onBlur:()=>c(null),style:{fontWeight:600},inputProps:{style:{marginLeft:20},placeholder:v?"New Group Name":""}})})}function Oa({group:n,collapsed:t,editingCell:s,dragState:a,MonthComponent:i,onEditName:r,onSave:c,onDelete:o,onDragChange:l,onReorderGroup:d,onReorderCategory:p,onToggleCollapse:g,onShowNewCategory:v}){const x=a&&a.item===n,{dragRef:T}=vt({type:"group",onDragChange:l,item:n,canDrag:s===null}),{dropRef:C,dropPos:h}=Je({types:"group",id:n.id,onDrop:d}),{dropRef:b,dropPos:R}=Je({types:"category",id:n.id,onDrop:p,onLongHover:()=>{t&&g(n.id)}});return e.jsxs(Ce,{collapsed:!0,style:{fontWeight:600,opacity:n.hidden?.33:void 0,backgroundColor:w.tableRowHeaderBackground},children:[a&&!a.preview&&a.type==="group"&&e.jsx(j,{innerRef:C,style:{position:"absolute",left:0,right:0,height:t?_t-1:(1+n.categories.length)*(_t-1)+1,zIndex:1e4},children:e.jsx(et,{pos:h,offset:{top:1}})}),e.jsx(et,{pos:R,offset:{top:1}}),e.jsxs(j,{innerRef:b,style:{flex:1,flexDirection:"row",opacity:x&&!a.preview?.3:1},children:[e.jsx(Dt,{innerRef:T,group:n,editing:s&&s.cell==="name"&&s.id===n.id,dragPreview:x&&a.preview,collapsed:t,onToggleCollapse:g,onEdit:r,onSave:c,onDelete:o,onShowNewCategory:v}),e.jsx(He,{component:i,args:{group:n}})]})]})}function Wa({cat:n,isLast:t,editingCell:s,MonthComponent:a,onEditName:i,onEditMonth:r,onSave:c,onDelete:o,onDragChange:l,onBudgetAction:d,onReorder:p,onShowActivity:g}){const{dragRef:v}=vt({type:"income-category",onDragChange:l,item:n,canDrag:s===null}),{dropRef:x,dropPos:T}=Je({types:"income-category",id:n.id,onDrop:p});return e.jsxs(Ce,{innerRef:x,collapsed:!0,style:{opacity:n.hidden?.5:void 0},children:[e.jsx(et,{pos:T,offset:{top:1}}),e.jsx(Mt,{innerRef:v,category:n,isLast:t,editing:s&&s.cell==="name"&&s.id===n.id,onEditName:i,onSave:c,onDelete:o}),e.jsx(He,{component:a,editingMonth:s&&s.id===n.id&&s.cell,args:{category:n,onEdit:r,isLast:t,onShowActivity:g,onBudgetAction:d}})]})}function $a({group:n,editingCell:t,collapsed:s,MonthComponent:a,onEditName:i,onSave:r,onToggleCollapse:c,onShowNewCategory:o}){return e.jsxs(Ce,{collapsed:!0,style:{fontWeight:600,backgroundColor:w.tableRowHeaderBackground},children:[e.jsx(Dt,{group:n,collapsed:s,editing:t&&t.cell==="name"&&t.id===n.id,onEdit:i,onSave:r,onToggleCollapse:c,onShowNewCategory:o}),e.jsx(He,{component:a,args:{group:n}})]})}function Ga({MonthComponent:n,onShowNewGroup:t}){return e.jsxs(j,{style:{flexDirection:"row",flex:1},children:[e.jsx(j,{style:{width:200,alignItems:"flex-start",justifyContent:"flex-start"},children:e.jsx(X,{onPress:t,style:{fontSize:12,margin:10},children:"Add Group"})}),e.jsx(He,{component:n,style:{border:0,justifyContent:"flex-end"}})]})}const wn=u.memo(({categoryGroups:n,editingCell:t,dataComponents:s,onBudgetAction:a,onShowActivity:i,onEditName:r,onEditMonth:c,onSaveCategory:o,onSaveGroup:l,onDeleteCategory:d,onDeleteGroup:p,onReorderCategory:g,onReorderGroup:v})=>{const[x=[],T]=De("budget.collapsed"),[C]=De("budget.showHiddenCategories");function h(y){T(y)}const[b,R]=u.useState(!1),[M,_]=u.useState(null),L=u.useMemo(()=>{const[y,A]=en(n);let f=Array.prototype.concat.apply([],y.map(S=>{if(S.hidden&&!C)return[];const I=S.categories.filter(z=>C||!z.hidden),N=[{type:"expense-group",value:{...S}}];return M===S.id&&N.push({type:"new-category"}),[...N,...(x.includes(S.id)?[]:I).map(z=>({type:"expense-category",value:z,group:S}))]}));return b&&f.push({type:"new-group"}),A&&(f=f.concat([{type:"income-separator"},{type:"income-group",value:A},M===A.id&&{type:"new-category"},...(x.includes(A.id)?[]:A.categories.filter(S=>C||!S.hidden)).map(S=>({type:"income-category",value:S}))].filter(S=>S))),f},[n,x,M,b,C]),[D,$]=u.useState(null),[E,k]=u.useState(null);function P(y){const{state:A}=y;A==="start-preview"?$({type:y.type,item:y.item,preview:!0}):A==="start"?D&&($({...D,preview:!1}),k(x)):A==="hover"?$({...D,hoveredId:y.id,hoveredPos:y.pos}):A==="end"&&($(null),h(E||[]))}function O(y){x.includes(y)?h(x.filter(A=>A!==y)):h([...x,y])}function H(){R(!0)}function q(){R(!1)}function G(y){l?.(y),y.id==="new"&&q()}function U(y){h(x.filter(A=>A!==y)),_(y)}function Z(){_(null)}function m(y){o?.(y),y.id==="new"&&Z()}return e.jsx(j,{style:{marginBottom:10,backgroundColor:w.tableBackground,overflow:"hidden",boxShadow:ce.cardShadow,borderRadius:"0 0 4px 4px",flex:1},children:L.map((y,A)=>{let f;switch(y.type){case"new-group":f=e.jsx(Ce,{style:{backgroundColor:w.tableRowHeaderBackground},children:e.jsx(Dt,{group:{id:"new",name:""},editing:!0,onSave:G,onHideNewGroup:q,onEdit:r})});break;case"new-category":f=e.jsx(Ce,{children:e.jsx(Mt,{category:{name:"",cat_group:M,is_income:M===n.find(I=>I.is_income).id,id:"new"},editing:!0,onSave:m,onHideNewCategory:Z,onEditName:r})});break;case"expense-group":f=e.jsx(Oa,{group:y.value,editingCell:t,collapsed:x.includes(y.value.id),MonthComponent:s.ExpenseGroupComponent,dragState:D,onEditName:r,onSave:G,onDelete:p,onDragChange:P,onReorderGroup:v,onReorderCategory:g,onToggleCollapse:O,onShowNewCategory:U});break;case"expense-category":f=e.jsx(Ua,{cat:y.value,categoryGroup:y.group,editingCell:t,MonthComponent:s.ExpenseCategoryComponent,dragState:D,onEditName:r,onEditMonth:c,onSave:m,onDelete:d,onDragChange:P,onReorder:g,onBudgetAction:a,onShowActivity:i});break;case"income-separator":f=e.jsx(j,{style:{height:ce.incomeHeaderHeight,backgroundColor:w.tableBackground},children:e.jsx(Ga,{MonthComponent:s.IncomeHeaderComponent,onShowNewGroup:H})});break;case"income-group":f=e.jsx($a,{group:y.value,editingCell:t,MonthComponent:s.IncomeGroupComponent,collapsed:x.includes(y.value.id),onEditName:r,onSave:G,onToggleCollapse:O,onShowNewCategory:U});break;case"income-category":f=e.jsx(Wa,{cat:y.value,editingCell:t,isLast:A===L.length-1,MonthComponent:s.IncomeCategoryComponent,onEditName:r,onEditMonth:c,onSave:m,onDelete:d,onDragChange:P,onReorder:g,onBudgetAction:a,onShowActivity:i});break;default:throw new Error("Unknown item type: "+y.type)}const S=A===0?"first":A===L.length-1?"last":null;return e.jsx(_n.Provider,{value:S,children:e.jsx(j,{style:!D&&{":hover":{backgroundColor:w.tableBackground}},children:f})},y.value?y.value.id:y.type==="income-separator"?"separator":A)})})});wn.displayName="BudgetCategories";function Qa({SummaryComponent:n}){const{months:t}=u.useContext(Xt),[s,a]=u.useState(0),[i,r]=Ln(()=>({x:0,config:{mass:3,tension:600,friction:80}})),c=Yt(u.useCallback(p=>{a(p.width)},[])),o=u.useRef(t[0]),l=[...t];l.unshift(ze(t[0],1)),l.push(Xe(t[t.length-1],1));const d=s/t.length;return u.useLayoutEffect(()=>{const p=o.current,g=p>t[0],v=d;let x=g?-v*2:0;p!==l[0]&&p!==l[2]&&(x=-v);const T=-v;r.start({from:{x},x:T})},[t[0]]),u.useLayoutEffect(()=>{o.current=t[0]},[t[0]]),u.useLayoutEffect(()=>{r.start({from:{x:-d},to:{x:-d}})},[d]),e.jsx("div",{className:`${Nn([{flex:1,overflow:"hidden"},t.length===1&&{marginLeft:-4,marginRight:-4}])}`,ref:c,children:e.jsx(Hn.div,{className:"view",style:{flexDirection:"row",width:s,willChange:"transform",transform:i.x.to(p=>`translateX(${p}px)`)},children:l.map(p=>e.jsx(j,{style:{flex:`0 0 ${d}px`,paddingLeft:4,paddingRight:4},children:e.jsx(n,{month:p})},p))})})}const za=u.memo(function({MonthComponent:t,toggleHiddenCategories:s,expandAllCategories:a,collapseAllCategories:i}){const[r,c]=u.useState(!1),o=u.useRef(null);return e.jsxs(j,{"data-testid":"budget-totals",style:{backgroundColor:w.tableBackground,flexDirection:"row",flexShrink:0,boxShadow:ce.cardShadow,marginLeft:5,marginRight:5+xt(),borderRadius:"4px 4px 0 0",borderBottom:"1px solid "+w.tableBorder},children:[e.jsxs(j,{style:{width:300,color:w.pageTextLight,justifyContent:"center",paddingLeft:15,paddingRight:5,display:"flex",flexDirection:"row",alignItems:"center",userSelect:"none",WebkitUserSelect:"none"},children:[e.jsx(j,{style:{flexGrow:"1"},children:"Category"}),e.jsx(X,{ref:o,variant:"bare","aria-label":"Menu",onPress:()=>c(!0),style:{color:"currentColor",padding:3},children:e.jsx(Un,{width:15,height:15,style:{color:w.pageTextLight}})}),e.jsx(je,{triggerRef:o,isOpen:r,onOpenChange:()=>c(!1),style:{width:200},children:e.jsx(me,{onMenuSelect:l=>{l==="toggle-visibility"?s():l==="expandAllCategories"?a():l==="collapseAllCategories"&&i(),c(!1)},items:[{name:"toggle-visibility",text:"Toggle hidden categories"},{name:"expandAllCategories",text:"Expand all"},{name:"collapseAllCategories",text:"Collapse all"}]})})]}),e.jsx(He,{component:t})]})});function bn(n){const{type:t,prewarmStartMonth:s,startMonth:a,numMonths:i,monthBounds:r,dataComponents:c,onSaveCategory:o,onDeleteCategory:l,onSaveGroup:d,onDeleteGroup:p,onReorderCategory:g,onReorderGroup:v,onShowActivity:x,onBudgetAction:T}=n,{grouped:C}=jt(),[h=[],b]=De("budget.collapsed"),[R,M]=De("budget.showHiddenCategories"),[_,L]=u.useState(null),D=(m,y)=>{L(m?{id:m,cell:y}:null)},$=m=>{L(m?{id:m,cell:"name"}:null)},E=(m,y,A)=>{if(!!C.find(S=>S.id===A)){const{targetId:S}=On(C,y,A),I=C.find(N=>N.id===S);if(I){const{categories:N}=I;g({id:m,groupId:I.id,targetId:N.length===0||y==="top"?null:N[0].id})}}else{let S;for(const I of C)if(I.categories.find(N=>N.id===A)){S=I;break}g({id:m,groupId:S.id,...Nt(S.categories,y,A)})}},k=(m,y,A)=>{const[f]=en(C);v({id:m,...Nt(f,y,A)})},P=m=>{const y=C.reduce((A,f)=>h.includes(f.id)?A.concat({id:f.id,isGroup:!0}):A.concat([{id:f.id,isGroup:!0},...f.categories]),[]);if(_){let f=y.findIndex(S=>S.id===_.id)+m;for(;f>=0&&f<y.length;){const S=y[f];if(S.isGroup){f+=m;continue}else if(t==="report"||!S.is_income){D(S.id,_.cell);return}else break}}},O=m=>{if(!_)return null;(m.key==="Enter"||m.key==="Tab")&&(m.preventDefault(),P(m.shiftKey?-1:1))},H=m=>{b(m)},q=()=>{M(!R)},G=()=>{q()},U=()=>{H([])},Z=()=>{H(C.map(m=>m.id))};return e.jsxs(j,{"data-testid":"budget-table",style:{flex:1,...ce.lightScrollbar&&{"& ::-webkit-scrollbar":{backgroundColor:"transparent"},"& ::-webkit-scrollbar-thumb:vertical":{backgroundColor:w.tableHeaderBackground}}},children:[e.jsxs(j,{style:{flexDirection:"row",overflow:"hidden",flexShrink:0,paddingLeft:5,paddingRight:5+xt()},children:[e.jsx(j,{style:{width:200}}),e.jsx(Lt,{startMonth:s,numMonths:i,monthBounds:r,type:t,children:e.jsx(Qa,{SummaryComponent:c.SummaryComponent})})]}),e.jsxs(Lt,{startMonth:a,numMonths:i,monthBounds:r,type:t,children:[e.jsx(za,{MonthComponent:c.BudgetTotalsComponent,toggleHiddenCategories:G,expandAllCategories:U,collapseAllCategories:Z}),e.jsx(j,{style:{overflowY:"scroll",overflowAnchor:"none",flex:1,paddingLeft:5,paddingRight:5},children:e.jsx(j,{style:{flexShrink:0},onKeyDown:O,children:e.jsx(wn,{categoryGroups:C,editingCell:_,dataComponents:c,onEditMonth:D,onEditName:$,onSaveCategory:o,onSaveGroup:d,onDeleteCategory:l,onDeleteGroup:p,onReorderCategory:E,onReorderGroup:k,onBudgetAction:T,onShowActivity:x})})})]})]})}bn.displayName="BudgetTable";function Va(n){const t=n-200;return t<500?1:t<750?2:t<1e3?3:t<1250?4:t<1500?5:6}const Sn=({type:n,width:t,height:s,prewarmStartMonth:a,startMonth:i,maxMonths:r=3,monthBounds:c,onMonthSelect:o,...l})=>{const{setDisplayMax:d}=$n(),p=Va(t),g=Math.min(p,r),v=200+500*g;u.useEffect(()=>{d(p)},[p]);function x(C){const h=c.start,b=ze(c.end,g-1);return C<h?h:C>b?b:C}function T(C){o(x(C),g)}return se("left",()=>{T(Gn(i))},{preventDefault:!0,scopes:["app"]},[T,i]),se("right",()=>{T(Qn(i))},{preventDefault:!0,scopes:["app"]},[T,i]),se("0",()=>{T(ze(mt(),n==="rollover"?Math.floor((g-1)/2):g===2?1:Math.max(g-2,0)))},{preventDefault:!0,scopes:["app"]},[T,i,g]),e.jsx(j,{style:{width:t,height:s,alignItems:"center",opacity:t<=0||s<=0?0:1},children:e.jsxs(j,{style:{width:"100%",maxWidth:v},children:[e.jsx(yn,{startMonth:a,numMonths:g,monthBounds:c,onMonthSelect:T}),e.jsx(bn,{prewarmStartMonth:a,startMonth:i,numMonths:g,monthBounds:c,...l})]})})};Sn.displayName="DynamicBudgetTableInner";const pt=n=>e.jsx(Wn,{children:({width:t,height:s})=>e.jsx(Sn,{width:t,height:s,...n})});pt.displayName="DynamicBudgetTable";function qa(n){const t=mt(),s=rs(),a=Ne(),i=tn(),[r,c]=De("budget.summaryCollapsed"),[o,l]=De("budget.startMonth"),d=o||t,[p,g]=u.useState({start:d,end:d}),[v="rollover"]=Re("budgetType"),[x]=cs("maxMonths"),T=x||1,[C,h]=u.useState(!1),{grouped:b}=jt();function R(){a(ds())}u.useEffect(()=>{async function m(){R();const{start:A,end:f}=await Y("get-budget-bounds");g({start:A,end:f}),await us(v,s,{start:A,end:f},d),h(!0)}m();const y=[ft("sync-event",({type:A,tables:f})=>{A==="success"&&(f.includes("categories")||f.includes("category_mapping")||f.includes("category_groups"))&&R()}),ft("undo-event",({tables:A})=>{A.includes("categories")&&R()})];return()=>{y.forEach(A=>A())}},[]),u.useEffect(()=>{Y("get-budget-bounds").then(({start:m,end:y})=>{(p.start!==m||p.end!==y)&&g({start:m,end:y})})},[n.accountId]);const M=async(m,y)=>{l(m);const A=m;m<d?await Ht(v,s,ze(m,1)):m>d&&await Ht(v,s,Xe(m,y)),A===m&&l(m)},_=m=>{a(Ss({type:"error",message:`Category ‘${m}’ already exists in group (May be Hidden)`}))},L=async m=>{if((await Y("get-categories")).grouped.filter(f=>f.id===m.cat_group)[0].categories.filter(f=>f.name.toUpperCase()===m.name.toUpperCase()).filter(f=>m.id==="new"?!0:f.id!==m.id).length>0){_(m.name);return}m.id==="new"?a(ps(m.name,m.cat_group,m.is_income,m.hidden)):a(gs(m))},D=async m=>{const y=await Y("must-category-transfer",{id:m});a(y?Pe("confirm-category-delete",{category:m,onDelete:A=>{m!==A&&a(Ut(m,A))}}):Ut(m))},$=m=>{m.id==="new"?a(ms(m.name)):a(xs(m))},E=async m=>{const y=b.find(f=>f.id===m);let A=!1;for(const f of y.categories)if(await Y("must-category-transfer",{id:f.id})){A=!0;break}a(A?Pe("confirm-category-delete",{group:m,onDelete:f=>{a(Ot(m,f))}}):Ot(m))},k=(m,y,A)=>{a(ys(m,y,A))},P=(m,y)=>{i("/accounts",{state:{goBack:!0,filterConditions:[{field:"category",op:"is",value:m,type:"id"},{field:"date",op:"is",value:y,options:{month:!0},type:"date"}],categoryId:m}})},O=async m=>{const y=await Y("get-categories"),A=y.list.filter(S=>S.id===m.id)[0];if(y.grouped.filter(S=>S.id===m.groupId)[0].categories.filter(S=>S.name.toUpperCase()===A.name.toUpperCase()).filter(S=>S.id!==A.id).length>0){_(A.name);return}a(ws(m.id,m.groupId,m.targetId))},H=async m=>{a(bs(m.id,m.targetId))},q=()=>{c(!r)},{reportComponents:G,rolloverComponents:U}=n;if(!C||!b)return null;let Z;return v==="report"?Z=e.jsx(hs,{summaryCollapsed:r,onBudgetAction:k,onToggleSummaryCollapse:q,children:e.jsx(pt,{type:v,prewarmStartMonth:d,startMonth:d,monthBounds:p,maxMonths:T,dataComponents:G,onMonthSelect:M,onDeleteCategory:D,onDeleteGroup:E,onSaveCategory:L,onSaveGroup:$,onBudgetAction:k,onShowActivity:P,onReorderCategory:O,onReorderGroup:H})}):Z=e.jsx(fs,{summaryCollapsed:r,onBudgetAction:k,onToggleSummaryCollapse:q,children:e.jsx(pt,{type:v,prewarmStartMonth:d,startMonth:d,monthBounds:p,maxMonths:T,dataComponents:U,onMonthSelect:M,onDeleteCategory:D,onDeleteGroup:E,onSaveCategory:L,onSaveGroup:$,onBudgetAction:k,onShowActivity:P,onReorderCategory:O,onReorderGroup:H})}),e.jsx(yt.Provider,{value:wt(d),children:e.jsx(j,{style:{flex:1},children:Z})})}const vn=u.memo(n=>e.jsx(ls,{...n}));vn.displayName="RolloverBudgetSummary";function ko(){const n=u.useMemo(()=>({SummaryComponent:zn,ExpenseCategoryComponent:Vn,ExpenseGroupComponent:qn,IncomeCategoryComponent:Zn,IncomeGroupComponent:Kn,BudgetTotalsComponent:Yn,IncomeHeaderComponent:Xn}),[Jn]),t=u.useMemo(()=>({SummaryComponent:vn,ExpenseCategoryComponent:es,ExpenseGroupComponent:ts,IncomeCategoryComponent:ns,IncomeGroupComponent:ss,BudgetTotalsComponent:as,IncomeHeaderComponent:os}),[is]);return e.jsx(j,{style:{...ce.page,paddingLeft:8,paddingRight:8,overflow:"hidden"},children:e.jsx(qa,{reportComponents:n,rolloverComponents:t})})}function Ao(){const{pushModal:n}=nn(),[t,s]=u.useState(""),a=vs();if(a==null)return null;const{schedules:i,statuses:r}=a;function c(p){n("schedule-edit",{id:p})}function o(){n("schedule-edit")}function l(){n("schedules-discover")}async function d(p,g){switch(p){case"post-transaction":await Y("schedule/post-transaction",{id:g});break;case"skip":await Y("schedule/skip-next-date",{id:g});break;case"complete":await Y("schedule/update",{schedule:{id:g,completed:!0}});break;case"restart":await Y("schedule/update",{schedule:{id:g,completed:!1},resetNextDate:!0});break;case"delete":await Y("schedule/delete",{id:g});break}}return e.jsxs(js,{header:"Schedules",children:[e.jsx(j,{style:{flexDirection:"row",alignItems:"center",padding:"0 0 15px"},children:e.jsx(j,{style:{flex:1,flexDirection:"row",justifyContent:"flex-end"},children:e.jsx(sn,{placeholder:"Filter schedules…",value:t,onChange:s})})}),e.jsx(Cs,{schedules:i,filter:t,statuses:r,allowCompleted:!0,onSelect:c,onAction:d,style:{backgroundColor:w.tableBackground}}),e.jsxs(j,{style:{flexDirection:"row",justifyContent:"space-between",margin:"20px 0",flexShrink:0},children:[e.jsx(X,{onPress:l,children:"Find schedules"}),e.jsx(X,{variant:"primary",onPress:o,children:"Add new schedule"})]})]})}function Bo(){return window.close(),e.jsx(Ts,{isCurrent:!0,title:"Account sync",children:()=>e.jsxs(j,{style:{maxWidth:500},children:[e.jsx(Wt,{children:"Please wait..."}),e.jsx(Wt,{children:"The window should close automatically. If nothing happened you can close this window or tab."})]})})}function jn(n,t){return!!([n,t].every(s=>s.transfer_id==null&&s.is_child===!1)&&n.account!==t.account&&n.amount+t.amount===0)}const Cn=u.createContext(null);function Pt(){const n=u.useContext(Cn);return u.useMemo(()=>({...n,expanded:t=>n.state.mode==="collapse"?!n.state.ids.has(t):n.state.ids.has(t)}),[n])}function Za({children:n,initialMode:t="expand"}){const s=Ee(o=>o.app.lastSplitState),a=Ne(),[i,r]=u.useReducer((o,l)=>{switch(l.type){case"toggle-split":{const d=new Set([...o.ids]),{id:p}=l;return d.has(p)?d.delete(p):d.add(p),{...o,ids:d}}case"open-split":{const d=new Set([...o.ids]),{id:p}=l;return o.mode==="collapse"?d.delete(p):d.add(p),{...o,ids:d}}case"close-splits":{const d=new Set([...o.ids]);return l.ids.forEach(p=>{o.mode==="collapse"?d.add(p):d.delete(p)}),{...o,ids:d}}case"set-mode":return{...o,mode:l.mode,ids:new Set,transitionId:null};case"switch-mode":return o.transitionId!=null?o:{...o,mode:o.mode==="expand"?"collapse":"expand",transitionId:l.id,ids:new Set};case"finish-switch-mode":return{...o,transitionId:null};default:throw new Error("Unknown action type: "+l.type)}},s.current||{ids:new Set,mode:t});u.useEffect(()=>{i.transitionId!=null&&setTimeout(()=>{r({type:"finish-switch-mode"})},250)},[i.transitionId]),u.useEffect(()=>{i.transitionId==null&&a({type:"SET_LAST_SPLIT_STATE",splitState:i})},[a,i]);const c=u.useMemo(()=>({state:i,dispatch:r}),[i,r]);return e.jsx(Cn.Provider,{value:c,children:n})}function Ka(n,t){return n?n[t]:""}function dt(n,t){let{amount:s,date:a}=n;Me(n.id)&&(s=(n._inverse?-1:1)*nt(s));let i=s<0?-s:null,r=s>0?s:null;return s===0&&(t?r=0:i=0),Hs(dn(a))||(a=null),{...n,date:a,debit:i!=null?tt(i):"",credit:r!=null?tt(r):""}}function Ya(n,t){const{debit:s,credit:a,date:i,...r}=n;let c;if(s!==""){const l=zt(s,null);c=l!=null?-l:null}else c=zt(a,null);c=c!=null?zs(c):t.amount;let o=i;return o==null&&(o=t.date||At()),{...r,date:o,amount:c}}function Tn(n,t){const s=n[t];return s&&s.is_child&&(n[t+1]==null||n[t+1].parent_id!==s.parent_id)}function ve(n,t,s,a="asc"){return n===s?t==="asc"?"desc":"asc":a}const kn=u.memo(({hasSelected:n,showAccount:t,showCategory:s,showBalance:a,showCleared:i,scrollWidth:r,onSort:c,ascDesc:o,field:l})=>{const d=an();return se("ctrl+a, cmd+a, meta+a",p=>d({type:"select-all",event:p}),{preventDefault:!0,scopes:["app"]},[d]),e.jsxs(Ce,{style:{fontWeight:300,zIndex:200,color:w.tableHeaderText,backgroundColor:w.tableBackground,paddingRight:`${5+(r??0)}px`,borderTopWidth:1,borderBottomWidth:1,borderColor:w.tableBorder},children:[e.jsx(on,{exposed:!0,focused:!1,selected:n,width:20,style:{borderTopWidth:0,borderBottomWidth:0},onSelect:p=>d({type:"select-all",isRangeSelect:p.shiftKey})}),e.jsx(ye,{value:"Date",width:110,alignItems:"flex",marginLeft:-5,id:"date",icon:l==="date"?o:"clickable",onClick:()=>c("date",ve(l,o,"date","desc"))}),t&&e.jsx(ye,{value:"Account",width:"flex",alignItems:"flex",marginLeft:-5,id:"account",icon:l==="account"?o:"clickable",onClick:()=>c("account",ve(l,o,"account","asc"))}),e.jsx(ye,{value:"Payee",width:"flex",alignItems:"flex",marginLeft:-5,id:"payee",icon:l==="payee"?o:"clickable",onClick:()=>c("payee",ve(l,o,"payee","asc"))}),e.jsx(ye,{value:"Notes",width:"flex",alignItems:"flex",marginLeft:-5,id:"notes",icon:l==="notes"?o:"clickable",onClick:()=>c("notes",ve(l,o,"notes","asc"))}),s&&e.jsx(ye,{value:"Category",width:"flex",alignItems:"flex",marginLeft:-5,id:"category",icon:l==="category"?o:"clickable",onClick:()=>c("category",ve(l,o,"category","asc"))}),e.jsx(ye,{value:"Payment",width:100,alignItems:"flex-end",marginRight:-5,id:"payment",icon:l==="payment"?o:"clickable",onClick:()=>c("payment",ve(l,o,"payment","asc"))}),e.jsx(ye,{value:"Deposit",width:100,alignItems:"flex-end",marginRight:-5,id:"deposit",icon:l==="deposit"?o:"clickable",onClick:()=>c("deposit",ve(l,o,"deposit","desc"))}),a&&e.jsx(ye,{value:"Balance",width:103,alignItems:"flex-end",marginRight:-5,id:"balance"}),i&&e.jsx(ye,{value:"✓",width:38,alignItems:"center",id:"cleared",icon:l==="cleared"?o:"clickable",onClick:()=>{c("cleared",ve(l,o,"cleared","asc"))}})]})});kn.displayName="TransactionHeader";function An(n,t,s,a=0){const i=c=>a>0?`${c} (+${a} more)`:c,{payee:r}=n;return s?e.jsx(j,{style:{flexDirection:"row",alignItems:"center"},children:e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis"},children:i(s.name)})}):t?i(t.name):r&&r.startsWith("new:")?i(r.slice(4)):""}function Xa({id:n,focused:t,selected:s,status:a,isChild:i,isPreview:r,onEdit:c,onUpdate:o}){const l=a==="cleared"||a==="reconciled"||a==null,d=Us(a),p=a==="cleared"?w.noticeTextLight:a==="reconciled"?w.noticeTextLight:a==="missed"?w.errorText:a==="due"?w.warningText:s?w.pageTextLinkLight:w.pageTextSubdued;function g(){l&&o("cleared",a!=="cleared")}return e.jsx(Ie,{name:"cleared",width:38,alignItems:"center",focused:t,style:{padding:1},plain:!0,children:e.jsx(Bt,{style:{padding:3,backgroundColor:"transparent",border:"1px solid transparent",borderRadius:50,":focus":{...r?{boxShadow:"none"}:{border:"1px solid "+w.formInputBorderSelected,boxShadow:"0 1px 2px "+w.formInputBorderSelected}},cursor:l?"pointer":"default",...i&&{visibility:"hidden"}},disabled:r||i,onEdit:()=>c(n,"cleared"),onSelect:g,children:u.createElement(d.Icon,{style:{width:13,height:13,color:p,marginTop:a==="due"?-1:0}})})})}function ye({value:n,id:t,width:s,alignItems:a,marginLeft:i,marginRight:r,icon:c,onClick:o}){const l={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:w.tableHeaderText,fontWeight:300,marginLeft:i,marginRight:r};return e.jsx(Qe,{width:s,name:t,alignItems:a,value:n,style:{borderTopWidth:0,borderBottomWidth:0},unexposedContent:({value:d})=>o?e.jsxs(X,{variant:"bare",onPress:o,style:l,children:[e.jsx(rn,{value:d}),c==="asc"&&e.jsx(Ma,{width:10,height:10,style:{marginLeft:5}}),c==="desc"&&e.jsx(Da,{width:10,height:10,style:{marginLeft:5}})]}):e.jsx(ee,{style:l,children:d})})}const Ja=(n,t,s)=>u.useMemo(()=>{if(!t)return null;const{counts:a,mostCommonPayeeTransaction:i}=t?.reduce(({counts:o,...l},d)=>d.payee&&(o[d.payee]=(o[d.payee]||0)+1,o[d.payee]>l.maxCount)?{counts:o,maxCount:o[d.payee],mostCommonPayeeTransaction:d}:{counts:o,...l},{counts:{},maxCount:0,mostCommonPayeeTransaction:null})||{};if(!i)return"Split (no payee)";const r=Ct(n)[i.payee],c=Object.keys(a).length;return An(i,r,s[i.id],c-1)},[t,n,s]);function eo({id:n,payee:t,focused:s,payees:a,accounts:i,transferAccountsByTransaction:r,valueStyle:c,transaction:o,subtransactions:l,importedPayee:d,isPreview:p,onEdit:g,onUpdate:v,onCreatePayee:x,onManagePayees:T,onNavigateToTransferAccount:C,onNavigateToSchedule:h}){const b=u.useRef(!1),R=Ne(),M=Ja(a,l,r),_=r[o.id];return o.is_parent?e.jsx(Ie,{name:"payee",width:"flex",focused:s,style:{padding:0},plain:!0,children:e.jsx(Bt,{bare:!0,style:{alignSelf:"flex-start",borderRadius:4,border:"1px solid transparent",":hover":p?{}:{border:"1px solid "+w.buttonNormalBorder}},disabled:p,onSelect:()=>R(Pe("payee-autocomplete",{onSelect:L=>{v("payee",L)}})),children:e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",alignSelf:"stretch",borderRadius:4,flex:1,padding:4,color:w.pageTextSubdued},children:[e.jsx(Zt,{transaction:o,transferAccount:_,onNavigateToTransferAccount:C,onNavigateToSchedule:h}),e.jsx(Os,{style:{color:"inherit",width:14,height:14,marginRight:5}}),e.jsx(ee,{style:{fontStyle:"italic",fontWeight:300,userSelect:"none",borderBottom:d?`1px dashed ${w.pageTextSubdued}`:"none"},children:d?e.jsx(Qt,{content:e.jsxs(j,{style:{padding:10},children:[e.jsx(ee,{style:{fontWeight:"bold"},children:"Imported Payee"}),e.jsx(ee,{style:{fontWeight:"normal"},children:d})]}),style:{...ce.tooltip,borderRadius:"0px 5px 5px 0px"},placement:"bottom",triggerProps:{delay:750},children:M}):M})]})})}):e.jsx(Qe,{width:"flex",name:"payee",textAlign:"flex",value:t?.id,valueStyle:c,exposed:s,onExpose:L=>!p&&g(n,L),onUpdate:async L=>{if(v("payee",L),L&&L.startsWith("new:")&&!b.current){b.current=!0;const D=await x(L.slice(4));v("payee",D),b.current=!1}},formatter:()=>An(o,t,_),unexposedContent:L=>{const D=e.jsx(rn,{...L,style:d?{borderBottom:`1px dashed ${w.pageTextSubdued}`}:{}});return e.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[e.jsx(Zt,{transaction:o,transferAccount:_,onNavigateToTransferAccount:C,onNavigateToSchedule:h}),d?e.jsx(Qt,{content:e.jsxs(j,{style:{padding:10},children:[e.jsx(ee,{style:{fontWeight:"bold"},children:"Imported Payee"}),e.jsx(ee,{style:{fontWeight:"normal"},children:d})]}),style:{...ce.tooltip,borderRadius:"0px 5px 5px 0px"},placement:"bottom",triggerProps:{delay:750},children:D}):D]})},children:({onBlur:L,onKeyDown:D,onUpdate:$,onSave:E,shouldSaveFromKey:k,inputStyle:P})=>e.jsx(Ws,{payees:a,accounts:i,value:t?.id,shouldSaveFromKey:k,inputProps:{onBlur:L,onKeyDown:D,style:P},showManagePayees:!0,clearOnBlur:!1,focused:!0,onUpdate:(O,H)=>$?.(H),onSelect:E,onManagePayees:()=>T(t?.id),menuPortalTarget:void 0})})}function Zt({transaction:n,transferAccount:t,onNavigateToTransferAccount:s,onNavigateToSchedule:a}){const i=n.schedule,r=un(),c=i&&r?r.schedules.find(g=>g.id===i):null,o=u.useMemo(()=>({marginLeft:-5,marginRight:2,width:23,height:23,color:"inherit"}),[]),l=u.useMemo(()=>({width:13,height:13}),[]),d=u.useMemo(()=>({width:10,height:10}),[]);if(c==null&&t==null)return null;const p=c&&c._date&&!!c._date.frequency;return e.jsxs(e.Fragment,{children:[c&&e.jsx(X,{variant:"bare","aria-label":"See schedule details",style:o,onPress:()=>{a(i)},children:p?e.jsx($s,{style:l}):e.jsx(Gs,{style:l})}),t&&e.jsx(X,{variant:"bare","aria-label":"See transfer account",style:o,onPress:()=>{re(n.id)||s(t.id)},children:(n._inverse?-1:1)*n.amount>0?e.jsx(Ia,{style:d}):e.jsx(Qs,{style:d})})]})}const Bn=u.memo(function({allTransactions:t,transaction:s,subtransactions:a,transferAccountsByTransaction:i,editing:r,showAccount:c,showBalance:o,showCleared:l,showZeroInDeposit:d,style:p,selected:g,highlighted:v,added:x,matched:T,expanded:C,focusedField:h,categoryGroups:b,payees:R,accounts:M,balance:_,dateFormat:L="MM/dd/yyyy",hideFraction:D,onSave:$,onEdit:E,onDelete:k,onSplit:P,onManagePayees:O,onCreatePayee:H,onToggleSplit:q,onNavigateToTransferAccount:G,onNavigateToSchedule:U,onNotesTagClick:Z,splitError:m,listContainerRef:y}){const A=Ne(),f=an(),S=u.useRef(null),[I,N]=u.useState(d),[z,te]=u.useState(s),[F,W]=u.useState(()=>dt(s,d)),V=Me(F.id);(s!==z||d!==I)&&(W(dt(s,d)),te(s),N(d));const[le,ne]=u.useState(!1);function K(B,J){F[B]!==J&&(F.reconciled===!0&&(B==="credit"||B==="debit"||B==="payee"||B==="account"||B==="date")?le===!1&&(ne(!0),A(Pe("confirm-transaction-edit",{onCancel:()=>{ne(!1)},onConfirm:()=>{ne(!1),ue(B,J)},confirmReason:"editReconciled"}))):ue(B,J)),B==="cleared"&&F.reconciled&&A(Pe("confirm-transaction-edit",{onConfirm:()=>{ue("reconciled",!1)},confirmReason:"unlockReconciled"}))}function ue(B,J){const de={...F,[B]:J};if(!(B==="note"&&J===""&&F.note==null))if(B==="account"&&J&&Ge(M)[J].offbudget&&(de.category=null),B==="credit"?de.debit="":B==="debit"&&(de.credit=""),B==="account"&&F.account!==J&&(de.reconciled=!1),B==="payee"&&J&&J.startsWith("new:"))W(de);else{const Se=Ya(de,s);W(dt(Se,d));const Be=["credit","debit"].includes(B)?"amount":B;$(Se,a,Be)}}const{id:Q,amount:Ue,debit:Te,credit:ke,payee:Ve,imported_payee:it,notes:Oe,date:fe,account:he,category:ae,cleared:Ae,reconciled:qe,is_parent:xe,_unmatched:We=!1,_inverse:Et=!1}=F,Ze=R&&Ve&&Ct(R)[Ve],pe=M&&he&&Ge(M)[he],oe=F.is_child,Ke=re(Q)?Ge(M)[Ze?.transfer_acct]:i[Q],ie=Ke&&Ke.offbudget===0,Ye=pe&&pe.offbudget===1,be=x?{fontWeight:600}:null,Ft=h==="select",rt=D?{letterSpacing:-.5}:null,ct=re(Q)?_+(Et?-1:1)*Ue:_,[Mn,Dn]=u.useState(1);return u.useEffect(()=>{m&&setTimeout(()=>{Dn(B=>B+1)},1)},[m,t]),e.jsxs(Ce,{ref:S,style:{backgroundColor:g?w.tableRowBackgroundHighlight:Ft?w.tableRowBackgroundHover:w.tableBackground,":hover":!(Ft||g)&&{backgroundColor:w.tableRowBackgroundHover},"& .hover-visible":{opacity:0},":hover .hover-visible":{opacity:1},...v||g?{color:w.tableRowBackgroundHighlightText}:{color:w.tableText},...p,...V&&{color:w.tableTextInactive,fontStyle:"italic"},...We&&{opacity:.5}},children:[m&&y.current&&e.jsx(je,{arrowSize:Mn,triggerRef:S,isOpen:!0,isNonModal:!0,style:{width:375,padding:5,maxHeight:"38px !important"},shouldFlip:!1,placement:"bottom end",UNSTABLE_portalContainer:y.current,children:m}),oe&&e.jsx(Gt,{width:110,style:{width:110,backgroundColor:w.tableRowBackgroundHover,border:0}}),oe&&c&&e.jsx(Gt,{style:{flex:1,backgroundColor:w.tableRowBackgroundHover,border:0}}),re(F.id)?oe?e.jsx(Ms,{onDelete:()=>k&&k(F.id),exposed:r,style:{...oe&&{borderLeftWidth:1},lineHeight:0}}):e.jsx(Ie,{width:20}):V&&oe?e.jsx(Ie,{width:20}):e.jsx(on,{exposed:!0,buttonProps:{className:g||r?null:"hover-visible"},focused:h==="select",onSelect:B=>{f({type:"select",id:F.id,isRangeSelect:B.shiftKey})},onEdit:()=>E(Q,"select"),selected:g,style:{...oe&&{borderLeftWidth:1}},value:T&&e.jsx(La,{style:{width:13,height:13,color:"inherit"}})}),!oe&&e.jsx(Qe,{name:"date",width:110,textAlign:"flex",exposed:h==="date",value:fe,valueStyle:be,formatter:B=>B?Ds(dn(B),L):"",onExpose:B=>!V&&E(Q,B),onUpdate:B=>{K("date",B)},children:({onBlur:B,onKeyDown:J,onUpdate:de,onSave:Se,shouldSaveFromKey:Be,inputStyle:$e})=>e.jsx(Ps,{value:fe||"",dateFormat:L,inputProps:{onBlur:B,onKeyDown:J,style:$e},shouldSaveFromKey:Be,clearOnBlur:!0,onUpdate:de,onSelect:Se})}),!oe&&c&&e.jsx(Qe,{name:"account",width:"flex",textAlign:"flex",value:he,formatter:B=>{const J=B&&Ge(M)[B];return J?J.name:""},valueStyle:be,exposed:h==="account",onExpose:B=>!V&&E(Q,B),onUpdate:async B=>{B&&K("account",B)},children:({onBlur:B,onKeyDown:J,onUpdate:de,onSave:Se,shouldSaveFromKey:Be,inputStyle:$e})=>e.jsx(Es,{includeClosedAccounts:!1,value:he,accounts:M,shouldSaveFromKey:Be,clearOnBlur:!1,focused:!0,inputProps:{onBlur:B,onKeyDown:J,style:$e},onUpdate:de,onSelect:Se,menuPortalTarget:void 0})}),e.jsx(eo,{id:Q,payee:Ze,focused:h==="payee",accounts:M.filter(B=>B.id!==he),payees:R.filter(B=>B.transfer_acct!==he),valueStyle:be,transaction:F,subtransactions:a,transferAccountsByTransaction:i,importedPayee:it,isPreview:V,onEdit:E,onUpdate:K,onCreatePayee:H,onManagePayees:O,onNavigateToTransferAccount:G,onNavigateToSchedule:U}),e.jsx(_e,{width:"flex",name:"notes",textAlign:"flex",exposed:h==="notes",focused:h==="notes",value:Oe||"",valueStyle:be,formatter:B=>so(B,Z),onExpose:B=>!V&&E(Q,B),inputProps:{value:Oe||"",onUpdate:K.bind(null,"notes")}}),V&&!oe||xe?e.jsxs(Ie,{name:"category",width:"flex",focused:h==="category",style:{padding:0,flexDirection:"row",alignItems:"center",justifyContent:"flex-start",height:"100%"},plain:!0,children:[V&&e.jsx(j,{style:{color:ae==="missed"?w.errorText:ae==="due"?w.warningText:g?w.formLabelText:w.upcomingText,backgroundColor:ae==="missed"?w.errorBackground:ae==="due"?w.warningBackground:g?w.formLabelBackground:w.upcomingBackground,margin:"0 5px",padding:"3px 7px",borderRadius:4},children:Fs(ae)}),e.jsx(Bt,{bare:!0,style:{borderRadius:4,border:"1px solid transparent",":hover":{border:"1px solid "+w.buttonNormalBorder}},disabled:re(F.id),onEdit:()=>!V&&E(Q,"category"),onSelect:()=>q(Q),children:e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",alignSelf:"stretch",borderRadius:4,flex:1,padding:4,color:w.pageTextSubdued},children:[xe&&e.jsx(bt,{style:{color:"inherit",width:14,height:14,transition:"transform .08s",transform:C?"rotateZ(0)":"rotateZ(-90deg)"}}),!V&&e.jsx(ee,{style:{fontStyle:"italic",fontWeight:300,userSelect:"none"},children:"Split"})]})})]}):ie||Ye?e.jsx(_e,{name:"category",width:"flex",exposed:h==="category",focused:h==="category",onExpose:B=>E(Q,B),value:xe?"Split":Ye?"Off Budget":ie?"Transfer":"",valueStyle:be,style:{fontStyle:"italic",color:w.pageTextSubdued,fontWeight:300},inputProps:{readOnly:!0,style:{fontStyle:"italic"}}}):e.jsx(Qe,{name:"category",width:"flex",textAlign:"flex",value:ae,formatter:B=>B?Ka(_s(b)[B],"name"):F.id?"Categorize":"",exposed:h==="category",onExpose:B=>!V&&E(Q,B),valueStyle:ae?be:{fontStyle:"italic",fontWeight:300,color:w.formInputTextHighlight},onUpdate:async B=>{B==="split"?P(F.id):K("category",B)},children:({onBlur:B,onKeyDown:J,onUpdate:de,onSave:Se,shouldSaveFromKey:Be,inputStyle:$e})=>e.jsx(yt.Provider,{value:wt(Ls(F.date)),children:e.jsx(Ns,{categoryGroups:b,value:ae,focused:!0,clearOnBlur:!1,showSplitOption:!oe&&!xe,shouldSaveFromKey:Be,inputProps:{onBlur:B,onKeyDown:J,style:$e},onUpdate:de,onSelect:Se,menuPortalTarget:void 0,showHiddenCategories:!1})})}),e.jsx(_e,{type:"input",width:100,name:"debit",exposed:h==="debit",focused:h==="debit",value:Te===""&&ke===""?"0.00":Te,valueStyle:be,textAlign:"right",title:Te,onExpose:B=>!V&&E(Q,B),style:{...xe&&{fontStyle:"italic"},...ce.tnum,...rt},inputProps:{value:Te===""&&ke===""?"0.00":Te,onUpdate:K.bind(null,"debit")},privacyFilter:{activationFilters:[!re(F.id)]}}),e.jsx(_e,{type:"input",width:100,name:"credit",exposed:h==="credit",focused:h==="credit",value:ke,valueStyle:be,textAlign:"right",title:ke,onExpose:B=>!V&&E(Q,B),style:{...xe&&{fontStyle:"italic"},...ce.tnum,...rt},inputProps:{value:ke,onUpdate:K.bind(null,"credit")},privacyFilter:{activationFilters:[!re(F.id)]}}),o&&e.jsx(Ie,{name:"balance",value:ct==null||oe?"":tt(ct),valueStyle:{color:ct<0?w.errorText:w.noticeTextLight},style:{...ce.tnum,...rt},width:103,textAlign:"right",privacyFilter:!0}),l&&e.jsx(Xa,{id:Q,focused:h==="cleared",selected:g,isPreview:V,status:V?ae:qe?"reconciled":Ae?"cleared":null,isChild:oe,onEdit:E,onUpdate:K}),e.jsx(Ie,{width:5})]})});function Rn({error:n,isDeposit:t,onAddSplit:s,onDistributeRemainder:a,style:i,canDistributeRemainder:r}){switch(n.type){case"SplitTransactionError":if(n.version===1)return e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",padding:"0 5px",...i},"data-testid":"transaction-error",children:[e.jsxs(ee,{children:["Amount left:"," ",e.jsx(ee,{style:{fontWeight:500},children:tt(t?n.difference:-n.difference)})]}),e.jsx(j,{style:{flex:1}}),e.jsx(X,{variant:"normal",style:{marginLeft:15},onPress:a,"data-testid":"distribute-split-button",isDisabled:!r,children:"Distribute"}),e.jsx(X,{variant:"primary",style:{marginLeft:10,padding:"4px 10px"},onPress:s,"data-testid":"add-split-button",children:"Add Split"})]});break;default:return null}}function ut(n,t,s){return[{id:"temp",date:s||At(),account:n||null,category:t||null,cleared:!1,amount:null}]}function to({transactions:n,accounts:t,categoryGroups:s,payees:a,transferAccountsByTransaction:i,editingTransaction:r,focusedField:c,showAccount:o,showCategory:l,showBalance:d,showCleared:p,dateFormat:g,hideFraction:v,onClose:x,onSplit:T,onEdit:C,onDelete:h,onSave:b,onAdd:R,onAddSplit:M,onDistributeRemainder:_,onManagePayees:L,onCreatePayee:D,onNavigateToTransferAccount:$,onNavigateToSchedule:E,onNotesTagClick:k,balance:P}){const O=n[0].error,H=n[0].amount>0,q=n.filter(U=>U.parent_id===n[0].id),G=q.filter(U=>U.amount===0);return e.jsxs(j,{style:{borderBottom:"1px solid "+w.tableBorderHover,paddingBottom:6,backgroundColor:w.tableBackground},"data-testid":"new-transaction",onKeyDown:U=>{U.key==="Escape"&&x()},children:[n.map(U=>e.jsx(Bn,{isNew:!0,editing:r===U.id,transaction:U,subtransactions:U.is_parent?q:null,transferAccountsByTransaction:i,showAccount:o,showCategory:l,showBalance:d,showCleared:p,focusedField:r===U.id&&c,showZeroInDeposit:H,accounts:t,categoryGroups:s,payees:a,dateFormat:g,hideFraction:v,expanded:!0,onEdit:C,onSave:b,onSplit:T,onDelete:h,onAdd:R,onManagePayees:L,onCreatePayee:D,style:{marginTop:-1},onNavigateToTransferAccount:$,onNavigateToSchedule:E,onNotesTagClick:k,balance:P},U.id)),e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",justifyContent:"flex-end",marginTop:6,marginRight:20},children:[e.jsx(X,{style:{marginRight:10,padding:"4px 10px"},onPress:()=>x(),"data-testid":"cancel-button",children:"Cancel"}),O?e.jsx(Rn,{error:O,isDeposit:H,onAddSplit:()=>M(n[0].id),onDistributeRemainder:()=>_(n[0].id),canDistributeRemainder:G.length>0}):e.jsx(X,{variant:"primary",style:{padding:"4px 10px"},onPress:R,"data-testid":"add-button",children:"Add"})]})]})}function no({tableNavigator:n,tableRef:t,listContainerRef:s,dateFormat:a="MM/dd/yyyy",newNavigator:i,renderEmpty:r,onScroll:c,...o}){const l=u.createRef(),d=Rs(o.isAdding),[p,g]=u.useState(0);function v(b,R){const M=b>0&&R>0&&b-R;g(M||0)}const x=u.useCallback(b=>{o.onCloseAddTransaction(),o.onNavigateToTransferAccount(b)},[o.onCloseAddTransaction,o.onNavigateToTransferAccount]),T=u.useCallback(b=>{o.onCloseAddTransaction(),o.onNavigateToSchedule(b)},[o.onCloseAddTransaction,o.onNavigateToSchedule]),C=u.useCallback(b=>{o.onCloseAddTransaction(),o.onNotesTagClick(b)},[o.onCloseAddTransaction,o.onNotesTagClick]);u.useEffect(()=>{!d&&o.isAdding&&i.onEdit("temp","date")},[d,o.isAdding,i]);const h=({item:b,index:R,editing:M})=>{const{transactions:_,selectedItems:L,accounts:D,categoryGroups:$,payees:E,showCleared:k,showAccount:P,showCategory:O,showBalances:H,balances:q,hideFraction:G,isNew:U,isMatched:Z,isExpanded:m}=o,y=b,A=L.has(y.id),f=o.transactionMap.get(y.parent_id),S=f&&f.amount>0,I=m&&m((f||y).id),N=I&&f&&f.error||y.error,z=(!I||Tn(_,R))&&N&&N.type==="SplitTransactionError",te=y.is_parent?o.transactionsByParent[y.id]:null,F=o.transactionsByParent[y.is_parent?y.id:y.parent_id]?.filter(W=>W.amount===0);return e.jsx(Bn,{allTransactions:o.transactions,editing:M,transaction:y,transferAccountsByTransaction:o.transferAccountsByTransaction,subtransactions:te,showAccount:P,showCategory:O,showBalance:H,showCleared:k,selected:A,highlighted:!1,added:U?.(y.id),expanded:m?.(y.id),matched:Z?.(y.id),showZeroInDeposit:S,balance:q?.[y.id]?.balance,focusedField:M&&n.focusedField,accounts:D,categoryGroups:$,payees:E,dateFormat:a,hideFraction:G,onEdit:n.onEdit,onSave:o.onSave,onDelete:o.onDelete,onSplit:o.onSplit,onManagePayees:o.onManagePayees,onCreatePayee:o.onCreatePayee,onToggleSplit:o.onToggleSplit,onNavigateToTransferAccount:x,onNavigateToSchedule:T,onNotesTagClick:C,splitError:z&&e.jsx(Rn,{error:N,isDeposit:S,onAddSplit:()=>o.onAddSplit(y.id),onDistributeRemainder:()=>o.onDistributeRemainder(y.id),canDistributeRemainder:F.length>0}),listContainerRef:s})};return e.jsxs(j,{innerRef:l,style:{flex:1,cursor:"default",...o.style},children:[e.jsxs(j,{children:[e.jsx(kn,{hasSelected:o.selectedItems.size>0,showAccount:o.showAccount,showCategory:o.showCategory,showBalance:o.showBalances,showCleared:o.showCleared,scrollWidth:p,onSort:o.onSort,ascDesc:o.ascDesc,field:o.sortField}),o.isAdding&&e.jsx(j,{...i.getNavigatorProps({onKeyDown:b=>o.onCheckNewEnter(b)}),children:e.jsx(to,{transactions:o.newTransactions,transferAccountsByTransaction:o.transferAccountsByTransaction,editingTransaction:i.editingId,focusedField:i.focusedField,accounts:o.accounts,categoryGroups:o.categoryGroups,payees:o.payees||[],showAccount:o.showAccount,showCategory:o.showCategory,showBalance:o.showBalances,showCleared:o.showCleared,dateFormat:a,hideFraction:o.hideFraction,onClose:o.onCloseAddTransaction,onAdd:o.onAddTemporary,onAddSplit:o.onAddSplit,onSplit:o.onSplit,onEdit:i.onEdit,onSave:o.onSave,onDelete:o.onDelete,onManagePayees:o.onManagePayees,onCreatePayee:o.onCreatePayee,onNavigateToTransferAccount:x,onNavigateToSchedule:T,onNotesTagClick:C,onDistributeRemainder:o.onDistributeRemainder,balance:o.transactions?.length>0?o.balances?.[o.transactions[0]?.id]?.balance:0})})]}),e.jsxs(j,{style:{flex:1,overflow:"hidden"},"data-testid":"transaction-table",children:[e.jsx(Is,{navigator:n,ref:t,listContainerRef:s,items:o.transactions,renderItem:h,renderEmpty:r,loadMore:o.loadMoreTransactions,isSelected:b=>o.selectedItems.has(b),onKeyDown:b=>o.onCheckEnter(b),onScroll:c,saveScrollWidth:v}),o.isAdding&&e.jsx("div",{style:{position:"absolute",top:-20,left:0,right:0,height:20,backgroundColor:w.errorText,boxShadow:"0 0 6px rgba(0, 0, 0, .20)"}},"shadow")]})]})}const In=u.forwardRef((n,t)=>{const[s,a]=u.useState(null),[i,r]=u.useState(!1),c=Pt(),o=u.useRef(null),l=u.useRef(null),d=u.useRef(null),p=ks(l,t),g=u.useMemo(()=>{let f;if(c.state.transitionId!=null){const S=n.transactions.findIndex(I=>I.id===c.state.transitionId);f=n.transactions.filter((I,N)=>{if(I.parent_id){if(N>=S)return c.expanded(I.parent_id);if(o.current)return o.current.expanded(I.parent_id)}return!0})}else o.current&&o.current.state.transitionId!=null&&(l.current.anchor(),l.current.setRowAnimation(!1)),o.current=c,f=n.transactions.filter(S=>S.parent_id?c.expanded(S.parent_id):!0);return o.current=c,f},[n.transactions,c]),v=u.useMemo(()=>new Map(g.map(f=>[f.id,f])),[g]),x=u.useMemo(()=>n.transactions.reduce((f,S)=>(S.is_child&&(f[S.parent_id]=[...f[S.parent_id]??[],S]),f),{}),[n.transactions]),T=u.useMemo(()=>{if(!n.accounts)return{};const f=Ge(n.accounts),S=Ct(n.payees);return Object.fromEntries(n.transactions.map(I=>{if(!n.accounts)return[I.id,null];const N=I.payee&&S[I.payee];let z;return I._inverse?z=I.account&&f[I.account]:z=N?.transfer_acct&&f[N.transfer_acct],[I.id,z||null]}))},[n.transactions,n.payees,n.accounts]);u.useEffect(()=>{l.current.isAnchored()&&(l.current.unanchor(),l.current.setRowAnimation(!0))},[o.current]);const C=$t(s,E),h=$t(g,E),b=u.useRef(!1),R=u.useRef({newTransactions:s,newNavigator:C,tableNavigator:h}),M=u.useRef(!1),_=u.useRef(!1),[L,D]=u.useState({}),$=Tt();u.useLayoutEffect(()=>{R.current={newTransactions:s,newNavigator:C,tableNavigator:h,transactions:n.transactions}}),i!==n.isAdding&&(!i&&n.isAdding&&a(ut(n.currentAccountId,n.currentCategoryId)),r(n.isAdding)),u.useEffect(()=>{if(b.current){if(s[0].account==null)n.addNotification({type:"error",message:"Account is a required field"}),C.onEdit("temp","account");else{const f=R.current.newTransactions,S=f.length>0?f[0].date:null;a(ut(n.currentAccountId,n.currentCategoryId,S)),C.onEdit("temp","date"),n.onAdd(f)}b.current=!1}}),u.useEffect(()=>{M.current&&_.current&&(_.current(n),_.current=null),M.current=!1},[s,n.transactions]);function E(f){let S=["select","date","account","payee","notes","category","debit","credit","cleared"];return S=f.is_child?["select","payee","notes","category","debit","credit"]:S.filter(I=>(n.showAccount||I!=="account")&&(n.showCategory||I!=="category")),Me(f.id)&&(S=["select"]),re(f.id)&&(S=S.slice(1)),S}function k(f){M.current?_.current=f:f(n)}function P(f){if(f.key==="Enter"){if(f.metaKey)f.stopPropagation(),H();else if(!f.shiftKey){let S=function(I){const{newTransactions:N}=I.current;return N[N.length-1]};C.editingId===S(R).id&&f.stopPropagation(),k(()=>{const I=S(R),N=I.parent_id||I.is_parent;R.current.newTransactions[0].error&&C.editingId===I.id?Z(I.id):C.editingId===I.id&&(!N||!I.error)&&H()})}}}function O(f){if(f.key==="Enter"&&!f.shiftKey){const{editingId:S,focusedField:I}=h;k(()=>{const N=R.current.transactions,z=N.findIndex(F=>F.id===S),te=N.find(F=>F.id===N[z]?.parent_id);Tn(N,z)&&te&&te.error&&I!=="select"&&(f.stopPropagation(),Z(S))})}}const H=u.useCallback(()=>{b.current=!0,D({})},[n.onAdd,C.onEdit]),q=u.useCallback(async(f,S=null,I=null)=>{M.current=!0;let N=S?As([f,...S]):f;if(re(f.id)){n.onApplyRules&&(N=await n.onApplyRules(N,I));const z=R.current.newTransactions;a(Fe(kt(z,N).data))}else n.onSave(N)},[n.onSave]),G=u.useCallback(f=>{if(re(f)){const I=R.current.newTransactions;if(f===I[0].id)return;a(Bs(I,f).data)}},[]),U=u.useMemo(()=>f=>{if(re(f)){const{newNavigator:S}=R.current,I=R.current.newTransactions,{data:N,diff:z}=cn(I,f);a(N),I[0].amount===null?S.onEdit(I[0].id,"debit"):S.onEdit(z.added[0].id,R.current.newNavigator.focusedField)}else{const S=R.current.transactions.find(z=>z.id===f),I=n.onSplit(f);c.dispatch({type:"open-split",id:S.id});const{tableNavigator:N}=R.current;S.amount===null?N.onEdit(S.id,"debit"):N.onEdit(I,N.focusedField)}},[n.onSplit,c.dispatch]),Z=u.useCallback(f=>{if(re(f)){const S=R.current.newTransactions,{data:I,diff:N}=ln(S,f);a(I),C.onEdit(N.added[0].id,R.current.newNavigator.focusedField)}else{const S=n.onAddSplit(f);h.onEdit(S,R.current.tableNavigator.focusedField)}},[n.onAddSplit]),m=u.useCallback(async f=>{const{transactions:S,tableNavigator:I,newTransactions:N}=R.current,z=re(f)?N:S,te=z.find(Q=>Q.id===f),F=te.is_parent?te:z.find(Q=>Q.id===te.parent_id),W=z.filter(Q=>Q.parent_id===(te.is_parent?te.id:te.parent_id)),V=W.filter(Q=>Q.amount===0),le=F.amount-W.reduce((Q,Ue)=>Q+Ue.amount,0),ne=Math.floor(le/V.length);let K=le-ne*V.length;const ue=new Array(V.length).fill(ne);for(const Q in ue){if(K===0)break;ue[Q]+=1,K--}re(f)?C.onEdit(null):I.onEdit(null);for(const Q in V)await q({...V[Q],amount:ue[Q]})},[R]);function y(){a(ut(n.currentAccountId,n.currentCategoryId)),n.onCloseAddTransaction()}const A=u.useCallback(f=>c.dispatch({type:"toggle-split",id:f}),[c.dispatch]);return e.jsx(no,{tableRef:p,listContainerRef:d,...n,transactions:g,transactionMap:v,transactionsByParent:x,transferAccountsByTransaction:T,selectedItems:$,isExpanded:c.expanded,onSave:q,onDelete:G,onSplit:U,onCheckNewEnter:P,onCheckEnter:O,onAddTemporary:H,onAddSplit:Z,onDistributeRemainder:m,onCloseAddTransaction:y,onToggleSplit:A,newTransactions:s,tableNavigator:h,newNavigator:C})});In.displayName="TransactionTable";function so(n,t){const s=n.split(" ");return e.jsx(e.Fragment,{children:s.map((a,i,r)=>{const c=r.length-1===i?"":" ";if(a.includes("#")&&a.length>1){let o=-1;return a.split("#").map((l,d)=>{if(d===0)return l;if(!l)return o=d,"#";if(o===d-1)return`${l} `;o=-1;const p=`#${l}`;return e.jsxs("span",{children:[e.jsx(X,{variant:"bare",style:({isHovered:g})=>({display:"inline-flex",padding:"3px 7px",borderRadius:16,userSelect:"none",backgroundColor:w.noteTagBackground,color:w.noteTagText,cursor:"pointer",...g?{backgroundColor:w.noteTagBackgroundHover}:{}}),onPress:()=>{t?.(p)},children:p},i),c]},`${p}${d}`)})}return`${a}${c}`})})}async function gt(n){const t=await Y("transactions-batch-update",{...n,learnCategories:!0});return t.length>0?{updates:t}:{}}async function ht(n,t,s){const a=await gt(n);s(qs(t.newTransaction,a),fn(a,t.data))}function ao({tableRef:n,transactions:t,allTransactions:s,loadMoreTransactions:a,account:i,accounts:r,category:c,categoryGroups:o,payees:l,balances:d,showBalances:p,showCleared:g,showAccount:v,headerContent:x,isAdding:T,isNew:C,isMatched:h,isFiltered:b,dateFormat:R,hideFraction:M,addNotification:_,renderEmpty:L,onSort:D,sortField:$,ascDesc:E,onChange:k,onRefetch:P,onCloseAddTransaction:O,onCreatePayee:H,onApplyFilter:q}){const G=Ne(),U=u.useRef(),Z=tn();u.useLayoutEffect(()=>{U.current=t},[t]);const m=u.useCallback(async F=>{F=hn(F),await gt({added:F}),P()},[]),y=u.useCallback(async F=>{const W=kt(U.current,F);W.diff.updated.length>0&&(!!W.diff.updated[0].date?(W.diff.updated[0].sort_order=Date.now(),await gt(W.diff),P()):(k(W.newTransaction,W.data),ht(W.diff,W,k)))},[]),A=u.useCallback(F=>{const W=ln(U.current,F);return k(W.newTransaction,W.data),ht(W.diff,W,k),W.diff.added[0].id},[]),f=u.useCallback(F=>{const W=cn(U.current,F);return k(W.newTransaction,W.data),ht(W.diff,W,k),W.diff.added[0].id},[]),S=u.useCallback(async(F,W=null)=>{const V=await Y("rules-run",{transaction:F}),le=Vs(F,V),ne={...F};return le&&(Object.keys(le).forEach(K=>{(ne[K]==null||ne[K]===""||ne[K]===0||ne[K]===!1)&&(ne[K]=le[K])}),F.is_parent&&le.subtransactions!==void 0&&W!==null&&(ne.subtransactions=le.subtransactions.map((K,ue)=>({...ne.subtransactions[ue]||K,...K[W]!=null&&{[W]:K[W]}})))),ne},[]),I=u.useCallback(F=>{Z("/payees",{state:{selectedPayee:F}})}),N=u.useCallback(F=>{Z(`/accounts/${F}`)}),z=u.useCallback(F=>{G(Pe("schedule-edit",{id:F}))}),te=u.useCallback(F=>{q({field:"notes",op:"hasTags",value:F,type:"string"})});return e.jsx(In,{ref:n,transactions:s,loadMoreTransactions:a,accounts:r,categoryGroups:o,payees:l,showBalances:p,balances:d,showCleared:g,showAccount:v,showCategory:!0,currentAccountId:i&&i.id,currentCategoryId:c&&c.id,isAdding:T,isNew:C,isMatched:h,isFiltered:b,dateFormat:R,hideFraction:M,addNotification:_,headerContent:x,renderEmpty:L,onSave:y,onApplyRules:S,onSplit:f,onCloseAddTransaction:O,onAdd:m,onAddSplit:A,onManagePayees:I,onCreatePayee:H,style:{backgroundColor:w.tableBackground},onNavigateToTransferAccount:N,onNavigateToSchedule:z,onNotesTagClick:te,onSort:D,sortField:$,ascDesc:E})}function oo({filterId:n,onFilterMenuSelect:t}){const{t:s}=ot();return e.jsx(me,{onMenuSelect:a=>{t(a)},items:n.id?n.id!==null&&n.status==="saved"?[{name:"rename-filter",text:s("Rename")},{name:"delete-filter",text:s("Delete")},me.line,{name:"save-filter",text:s("Save new filter"),disabled:!0},{name:"clear-filter",text:s("Clear all conditions")}]:[{name:"rename-filter",text:s("Rename")},{name:"update-filter",text:s("Update condtions")},{name:"reload-filter",text:s("Revert changes")},{name:"delete-filter",text:s("Delete")},me.line,{name:"save-filter",text:s("Save new filter")},{name:"clear-filter",text:s("Clear all conditions")}]:[{name:"save-filter",text:s("Save new filter")},{name:"clear-filter",text:s("Clear all conditions")}]})}function io({menuItem:n,name:t,setName:s,adding:a,onAddUpdate:i,err:r}){const{t:c}=ot(),o=u.useRef(null);return u.useEffect(()=>{o.current&&o.current.focus()},[]),e.jsxs(e.Fragment,{children:[n!=="update-filter"&&e.jsx("form",{children:e.jsxs(st,{direction:"row",justify:"flex-end",align:"center",style:{padding:10},children:[e.jsxs(Zs,{style:{flex:1},children:[e.jsx(Ks,{title:c("Filter Name"),htmlFor:"name-field",style:{userSelect:"none"}}),e.jsx(Rt,{id:"name-field",inputRef:o,defaultValue:t||"",onChangeValue:s})]}),e.jsx(pn,{type:"primary",style:{marginTop:18},onClick:l=>{l.preventDefault(),i()},children:c(a?"Add":"Update")})]})}),r&&e.jsx(st,{direction:"row",align:"center",style:{padding:10},children:e.jsx(ee,{style:{color:w.errorText},children:r})})]})}function ro({conditions:n,conditionsOp:t,filterId:s,onClearFilters:a,onReloadSavedFilter:i,savedFilters:r}){const{t:c}=ot(),[o,l]=u.useState(!1),[d,p]=u.useState(!1),[g,v]=u.useState(!1),x=u.useRef(null),[T,C]=u.useState(null),[h,b]=u.useState(""),[R,M]=u.useState(s.name),_=s.id;let L;const D=async E=>{switch(b(E),E){case"rename-filter":C(null),p(!1),v(!1),l(!0);break;case"delete-filter":v(!1),await Y("filter-delete",_),a();break;case"update-filter":C(null),p(!1),v(!1),L={conditions:n,conditionsOp:t,id:s.id,name:s.name,status:"saved"};const k=await lt("filter-update",{state:L,filters:[...r]});if(k.error){C(k.error.message),l(!0);return}i(L,"update");break;case"save-filter":C(null),p(!0),v(!1),l(!0);break;case"reload-filter":v(!1),L={...L,status:"saved"},i(L,"reload");break;case"clear-filter":v(!1),a();break}};async function $(){if(d){const P={conditions:n,conditionsOp:t,name:R,status:"saved"},O=await lt("filter-create",{state:P,filters:[...r]});if(O.error){C(O.error.message),l(!0);return}l(!1),i({...P,id:O.data});return}const E={conditions:s.conditions,conditionsOp:s.conditionsOp,id:s.id,name:R},k=await lt("filter-update",{state:E,filters:[...r]});if(k.error){C(k.error.message),l(!0);return}l(!1),i(E)}return e.jsxs(j,{children:[n.length>0&&e.jsxs(pn,{ref:x,type:"bare",style:{marginTop:10},onClick:()=>{v(!0)},children:[e.jsxs(ee,{style:{maxWidth:150,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flexShrink:0},children:[s.id?s.name:c("Unsaved filter")," "]}),s.id&&s.status!=="saved"&&e.jsxs(ee,{children:[e.jsx(Ys,{children:"(modified)"})," "]}),e.jsx(Jt,{width:8,height:8,style:{marginRight:5}})]}),e.jsx(je,{triggerRef:x,isOpen:g,onOpenChange:()=>v(!1),style:{width:200},children:e.jsx(oo,{filterId:s,onFilterMenuSelect:D})}),e.jsx(je,{triggerRef:x,isOpen:o,onOpenChange:()=>l(!1),style:{width:325},children:e.jsx(io,{menuItem:h,name:R,setName:M,adding:d,onAddUpdate:$,err:T})})]})}function co({conditions:n,conditionsOp:t,onUpdateFilter:s,onDeleteFilter:a,onClearFilters:i,onReloadSavedFilter:r,filterId:c,savedFilters:o,onConditionsOpChange:l}){return e.jsx(j,{children:e.jsxs(st,{spacing:2,direction:"row",justify:"flex-start",align:"flex-start",children:[e.jsx(Ba,{conditions:n,conditionsOp:t,onConditionsOpChange:l,onUpdate:s,onDelete:a}),e.jsx(j,{style:{flex:1}}),e.jsx(ro,{conditions:n,conditionsOp:t,filterId:c,onClearFilters:i,onReloadSavedFilter:r,savedFilters:o})]})})}function lo({getTransaction:n,onShow:t,onDuplicate:s,onDelete:a,onEdit:i,onLinkSchedule:r,onUnlinkSchedule:c,onCreateRule:o,onSetTransfer:l,onScheduleAction:d,showMakeTransfer:p,onMakeAsSplitTransaction:g,onMakeAsNonSplitTransactions:v}){const{t:x}=ot(),T=Ne(),C=Tt(),h=u.useMemo(()=>[...C],[C]),b=u.useMemo(()=>{const k=h;return{preview:!!k.find(P=>Me(P)),trans:!!k.find(P=>!Me(P))}},[h]),R=u.useMemo(()=>h.map(P=>n(P)).some(P=>P&&P.is_child),[h,n]),M=u.useMemo(()=>!b.preview&&h.every(k=>{const P=n(k);return P&&P.schedule}),[b.preview,h,n]),_=u.useMemo(()=>{if(h.length!==2)return!1;const k=n(h[0]),P=n(h[1]);return!k||!P?!1:jn(k,P)},[h,n]),L=u.useMemo(()=>{if(h.length<=1||b.preview)return!1;const k=h.map(G=>n(G)),[P]=k,O=k.every(G=>G&&G.date===P.date&&G.account===P.account),H=k.every(G=>G&&!G.is_parent&&!G.is_child),q=k.every(G=>G&&!G.reconciled);return O&&H&&q},[h,b,n]),D=u.useMemo(()=>{if(h.length===0||b.preview)return!1;const k=h.map(H=>n(H)),P=k.every(H=>H&&!H.reconciled),O=k.every(H=>H&&(H.is_parent||H.is_child));return P&&O},[h,b,n]);function $(){const k=h[0];let P;if(Me(k))P=k.split("/")[1];else{const O=n(k);P=O&&O.schedule}P&&T(Pe("schedule-edit",{id:P}))}const E={enabled:b.trans,scopes:["app"]};return se("f",()=>t(h),E,[t,h]),se("d",()=>a(h),E,[a,h]),se("a",()=>i("account",h),E,[i,h]),se("p",()=>i("payee",h),E,[i,h]),se("n",()=>i("notes",h),E,[i,h]),se("c",()=>i("category",h),E,[i,h]),se("l",()=>i("cleared",h),E,[i,h]),se("s",()=>!b.trans||M?$():r(h),{scopes:["app"]},[r,$,M,h]),e.jsx(Xs,{id:"transactions",name:k=>x("{{count}} transactions",{count:k}),items:[...b.trans?[{name:"show",text:x("Show"),key:"F"},{name:"duplicate",text:x("Duplicate"),disabled:R},{name:"delete",text:x("Delete"),key:"D"},...M?[{name:"view-schedule",text:x("View schedule"),key:"S",disabled:h.length>1},{name:"unlink-schedule",text:x("Unlink schedule")}]:[{name:"link-schedule",text:x("Link schedule"),key:"S"},{name:"create-rule",text:x("Create rule")}],...p?[{name:"set-transfer",text:x("Make transfer"),disabled:!_}]:[],...L?[{name:"make-as-split-transaction",text:x("Make as split transaction")}]:[],...D?[{name:"unsplit-transactions",text:x("Unsplit {{count}} transactions",{count:h.length})}]:[],me.line,{type:me.label,name:x("Edit field")},{name:"date",text:x("Date")},{name:"account",text:x("Account"),key:"A"},{name:"payee",text:x("Payee"),key:"P"},{name:"notes",text:x("Notes"),key:"N"},{name:"category",text:x("Category"),key:"C"},{name:"amount",text:x("Amount")},{name:"cleared",text:x("Cleared"),key:"L"}]:[{name:"view-schedule",text:x("View schedule"),key:"S"},{name:"post-transaction",text:x("Post transaction")},{name:"skip",text:x("Skip scheduled date")}]],onSelect:k=>{switch(k){case"show":t(h);break;case"duplicate":s(h);break;case"delete":a(h);break;case"make-as-split-transaction":g(h);break;case"unsplit-transactions":v(h);break;case"post-transaction":case"skip":d(k,h);break;case"view-schedule":$();break;case"link-schedule":r(h);break;case"unlink-schedule":c(h);break;case"create-rule":o(h);break;case"set-transfer":l(h);break;default:i(k,h)}}})}function at({name:n,balance:t,isExactBalance:s=!0}){const a=It();return e.jsxs(ee,{style:{marginLeft:15,borderRadius:4,padding:"4px 6px",color:w.pillText,backgroundColor:w.pillBackground},children:[n," ",e.jsx(ta,{children:e.jsxs(ee,{style:{fontWeight:600},children:[!s&&"~ ",a(t,"financial")]})})]})}function uo({selectedItems:n,account:t}){const s=`selected-balance-${[...n].join("-")}`,a=Le({name:s,query:we("transactions").filter({id:{$oneof:[...n]},parent_id:{$oneof:[...n]}}).select("id")}),i=new Set((a||[]).map(v=>v.id)),r=[...n].filter(v=>!i.has(v));let c=Le({name:s+"-sum",query:we("transactions").filter({id:{$oneof:r}}).options({splits:"all"}).calculate({$sum:"$amount"})}),o=null;const l=un(),d=l?l.schedules:[],p=[...n].filter(v=>Me(v)).map(v=>v.slice(8));let g=!0;for(const v of d)p.includes(v.id)&&(v._amountOp==="isbetween"&&(g=!1),!t||t.id===v._account?o+=nt(v._amount):o-=nt(v._amount));if(c==null){if(o==null)return null;c=o}else o!=null&&(c+=o);return e.jsx(at,{name:"Selected balance:",balance:c,isExactBalance:g})}function ho({filteredAmount:n}){return e.jsx(at,{name:"Filtered balance:",balance:n||0,isExactBalance:!0})}function fo({balanceQuery:n}){const t=Le({name:n.name+"-cleared",query:n.query.filter({cleared:!0})}),s=Le({name:n.name+"-uncleared",query:n.query.filter({cleared:!1})});return e.jsxs(j,{style:{flexDirection:"row"},children:[e.jsx(at,{name:"Cleared total:",balance:t}),e.jsx(at,{name:"Uncleared total:",balance:s})]})}function po({balanceQuery:n,showExtraBalances:t,onToggleExtraBalances:s,account:a,isFiltered:i,filteredAmount:r}){const c=Tt(),o=u.useRef(null),l=Js(o);return e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",marginTop:-5,marginLeft:-5},children:[e.jsxs(X,{ref:o,"data-testid":"account-balance",variant:"bare",onPress:s,style:{paddingTop:1,paddingBottom:1},children:[e.jsx(ea,{binding:{...n,value:0},type:"financial",style:{fontSize:22,fontWeight:400},getStyle:d=>({color:d<0?w.errorText:d>0?w.noticeTextLight:w.pageTextSubdued}),privacyFilter:{blurIntensity:5}}),e.jsx(Pa,{style:{width:10,height:10,marginLeft:10,color:w.pillText,transform:t?"rotateZ(180deg)":"rotateZ(0)",opacity:l||c.size>0||t?1:0}})]}),t&&e.jsx(fo,{balanceQuery:n}),c.size>0&&e.jsx(uo,{selectedItems:c,account:a}),i&&e.jsx(ho,{filteredAmount:r})]})}function go({balanceQuery:n,targetBalance:t,onDone:s,onCreateTransaction:a}){const i=Le({name:n.name+"-cleared",value:0,query:n.query.filter({cleared:!0})}),r=It(),c=t-i;return e.jsx(j,{style:{flexDirection:"row",alignSelf:"center",backgroundColor:w.tableBackground,...ce.shadow,borderRadius:4,marginTop:5,marginBottom:15,padding:10},children:e.jsxs(j,{style:{flexDirection:"row",alignItems:"center"},children:[c===0?e.jsxs(j,{style:{color:w.noticeTextLight,flex:1,flexDirection:"row",alignItems:"center",justifyContent:"center"},children:[e.jsx(na,{style:{width:13,height:13,color:"inherit",marginRight:3}}),"All reconciled!"]}):e.jsx(j,{style:{color:w.tableText},children:e.jsxs(ee,{style:{fontStyle:"italic",textAlign:"center"},children:["Your cleared balance"," ",e.jsx("strong",{children:r(i,"financial")})," needs"," ",e.jsx("strong",{children:(c>0?"+":"")+r(c,"financial")})," ","to match",e.jsx("br",{})," your bank’s balance of"," ",e.jsx(ee,{style:{fontWeight:700},children:r(t,"financial")})]})}),e.jsx(j,{style:{marginLeft:15},children:e.jsx(X,{variant:"primary",autoFocus:!0,onPress:s,children:"Done Reconciling"})}),c!==0&&e.jsx(j,{style:{marginLeft:15},children:e.jsx(X,{onPress:()=>a(c),children:"Create Reconciliation Transaction"})})]})})}function mo({account:n,onReconcile:t,onClose:s}){const a=sa(n),i=Le({name:a.name+"-cleared",value:null,query:a.query.filter({cleared:!0})}),r=It(),[c,o]=u.useState(null),[l,d]=u.useState(!1);function p(){if(c===""){d(!0);return}const g=c!=null?aa(c):i;t(g),s()}return e.jsxs(j,{style:{padding:"5px 8px"},children:[e.jsx(ee,{children:"Enter the current balance of your bank account that you want to reconcile with:"}),i!=null&&e.jsx(gn,{children:e.jsx(Rt,{defaultValue:r(i,"financial"),onChangeValue:o,style:{margin:"7px 0"},focused:l,onEnter:p})}),e.jsx(X,{variant:"primary",onPress:p,children:"Reconcile"})]})}function xo({tableRef:n,editingName:t,isNameEditable:s,workingHard:a,accountName:i,account:r,filterId:c,savedFilters:o,accountsSyncing:l,failedAccounts:d,accounts:p,transactions:g,showBalances:v,showExtraBalances:x,showCleared:T,showReconciled:C,showEmptyMessage:h,balanceQuery:b,reconcileAmount:R,canCalculateBalance:M,isFiltered:_,filteredAmount:L,isSorted:D,search:$,filterConditions:E,filterConditionsOp:k,pushModal:P,onSearch:O,onAddTransaction:H,onShowTransactions:q,onDoneReconciling:G,onCreateReconciliationTransaction:U,onToggleExtraBalances:Z,onSaveName:m,onExposeName:y,onSync:A,onImport:f,onMenuSelect:S,onReconcile:I,onBatchDelete:N,onBatchDuplicate:z,onBatchEdit:te,onBatchLinkSchedule:F,onBatchUnlinkSchedule:W,onCreateRule:V,onApplyFilter:le,onUpdateFilter:ne,onClearFilters:K,onReloadSavedFilter:ue,onConditionsOpChange:Q,onDeleteFilter:Ue,onScheduleAction:Te,onSetTransfer:ke,onMakeAsSplitTransaction:Ve,onMakeAsNonSplitTransactions:it}){const[Oe,fe]=u.useState(!1),he=u.useRef(null),ae=u.useRef(null),Ae=Pt(),qe=mn(),xe=qe!=="no-server",We=qe==="offline",[Et,Ze]=De("expand-splits");let pe=r&&r.account_id&&xe;r||(pe=!!p.find(ie=>!!ie.account_id)&&xe);const oe=!r;function Ke(){n.current&&(Ae.dispatch({type:"switch-mode",id:n.current.getScrolledItem()}),Ze(Ae.state.mode!=="expand"))}return se("ctrl+f, cmd+f, meta+f",()=>{he.current&&he.current.focus()},{enableOnFormTags:!0,preventDefault:!0,scopes:["app"]},[he]),se("t",()=>H(),{preventDefault:!0,scopes:["app"]},[H]),se("ctrl+i, cmd+i, meta+i",()=>f(),{scopes:["app"]},[f]),se("ctrl+b, cmd+b, meta+b",()=>A(),{enabled:pe&&!We,preventDefault:!0,scopes:["app"]},[A]),e.jsxs(e.Fragment,{children:[e.jsxs(j,{style:{...ce.pageContent,paddingBottom:10,flexShrink:0},children:[e.jsx(j,{style:{marginTop:2,marginBottom:10,alignItems:"flex-start"},children:e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",gap:3},children:[!!r?.bank&&e.jsx(j,{style:{backgroundColor:l.includes(r.id)?w.sidebarItemBackgroundPending:d.has(r.id)?w.sidebarItemBackgroundFailed:w.sidebarItemBackgroundPositive,marginRight:"4px",width:8,height:8,borderRadius:8}}),t?e.jsx(gn,{children:e.jsx(Rt,{defaultValue:i,onEnter:ie=>m(ie.target.value),onBlur:ie=>m(ie.target.value),onEscape:()=>y(!1),style:{fontSize:25,fontWeight:500,marginTop:-3,marginBottom:-4,marginLeft:-6,paddingTop:2,paddingBottom:2,width:Math.max(20,i.length)+"ch"}})}):s?e.jsxs(j,{style:{flexDirection:"row",alignItems:"center",gap:3,"& .hover-visible":{opacity:0,transition:"opacity .25s"},"&:hover .hover-visible":{opacity:1}},children:[e.jsx(j,{style:{fontSize:25,fontWeight:500,marginRight:5,marginBottom:-1},"data-testid":"account-name",children:r&&r.closed?"Closed: "+i:i}),r&&e.jsx(St,{id:`account-${r.id}`,defaultColor:w.pageTextSubdued}),e.jsx(X,{variant:"bare","aria-label":"Edit account name",className:"hover-visible",onPress:()=>y(!0),children:e.jsx(Na,{style:{width:11,height:11,color:w.pageTextSubdued}})})]}):e.jsx(j,{style:{fontSize:25,fontWeight:500,marginBottom:-1},"data-testid":"account-name",children:r&&r.closed?"Closed: "+i:i})]})}),e.jsx(po,{balanceQuery:b,showExtraBalances:x,onToggleExtraBalances:Z,account:r,isFiltered:_,filteredAmount:L}),e.jsxs(st,{spacing:2,direction:"row",align:"center",style:{marginTop:12},children:[(r&&!r.closed||pe)&&e.jsx(X,{variant:"bare",onPress:pe?A:f,isDisabled:pe&&We,children:pe?e.jsxs(e.Fragment,{children:[e.jsx(oa,{width:13,height:13,animating:r?l.includes(r.id):l.length>0,style:{marginRight:4}})," ",We?"Bank Sync Offline":"Bank Sync"]}):e.jsxs(e.Fragment,{children:[e.jsx(_a,{width:13,height:13,style:{marginRight:4}})," ","Import"]})}),!h&&e.jsxs(X,{variant:"bare",onPress:H,children:[e.jsx(ia,{width:10,height:10,style:{marginRight:3}})," Add New"]}),e.jsx(j,{style:{flexShrink:0},children:e.jsx(Ra,{onApply:le,type:"accounts"})}),e.jsx(j,{style:{flex:1}}),e.jsx(sn,{placeholder:"Search",value:$,onChange:O,inputRef:he}),a?e.jsx(j,{children:e.jsx(ra,{style:{width:16,height:16}})}):e.jsx(lo,{account:r,getTransaction:ie=>g.find(Ye=>Ye.id===ie),onShow:q,onDuplicate:z,onDelete:N,onEdit:te,onLinkSchedule:F,onUnlinkSchedule:W,onCreateRule:V,onSetTransfer:ke,onScheduleAction:Te,pushModal:P,showMakeTransfer:oe,onMakeAsSplitTransaction:Ve,onMakeAsNonSplitTransactions:it}),e.jsx(X,{variant:"bare","aria-label":Ae.state.mode==="collapse"?"Collapse split transactions":"Expand split transactions",isDisabled:$!==""||E.length>0,style:{padding:6,marginLeft:10},onPress:Ke,children:e.jsx(j,{title:Ae.state.mode==="collapse"?"Collapse split transactions":"Expand split transactions",children:Ae.state.mode==="collapse"?e.jsx(Fa,{style:{width:14,height:14}}):e.jsx(Ea,{style:{width:14,height:14}})})}),r?e.jsxs(j,{children:[e.jsx(qt,{"aria-label":"Account menu",ref:ae,onPress:()=>fe(!0)}),e.jsx(je,{triggerRef:ae,style:{width:275},isOpen:Oe,onOpenChange:()=>fe(!1),children:e.jsx(yo,{account:r,canSync:pe,canShowBalances:M(),isSorted:D,showBalances:v,showCleared:T,showReconciled:C,onMenuSelect:ie=>{fe(!1),S(ie)},onReconcile:I,onClose:()=>fe(!1)})})]}):e.jsxs(j,{children:[e.jsx(qt,{"aria-label":"Account menu",ref:ae,onPress:()=>fe(!0)}),e.jsx(je,{triggerRef:ae,isOpen:Oe,onOpenChange:()=>fe(!1),children:e.jsx(me,{onMenuSelect:ie=>{fe(!1),S(ie)},items:[D&&{name:"remove-sorting",text:"Remove all sorting"},{name:"export",text:"Export"}]})})]})]}),E?.length>0&&e.jsx(co,{conditions:E,conditionsOp:k,onUpdateFilter:ne,onDeleteFilter:Ue,onClearFilters:K,onReloadSavedFilter:ue,filterId:c,savedFilters:o,onConditionsOpChange:Q})]}),R!=null&&e.jsx(go,{targetBalance:R,balanceQuery:b,onDone:G,onCreateTransaction:U})]})}function yo({account:n,canSync:t,showBalances:s,canShowBalances:a,showCleared:i,showReconciled:r,onClose:c,isSorted:o,onReconcile:l,onMenuSelect:d}){const[p,g]=u.useState("default"),v=mn();return p==="reconcile"?e.jsx(mo,{account:n,onClose:c,onReconcile:l}):e.jsx(me,{onMenuSelect:x=>{x==="reconcile"?g("reconcile"):d(x)},items:[o&&{name:"remove-sorting",text:"Remove all sorting"},a&&{name:"toggle-balance",text:(s?"Hide":"Show")+" running balance"},{name:"toggle-cleared",text:(i?"Hide":"Show")+" “cleared” checkboxes"},{name:"toggle-reconciled",text:(r?"Hide":"Show")+" reconciled transactions"},{name:"export",text:"Export"},{name:"reconcile",text:"Reconcile"},n&&!n.closed&&(t?{name:"unlink",text:"Unlink account"}:v==="online"&&{name:"link",text:"Link account"}),n.closed?{name:"reopen",text:"Reopen account"}:{name:"close",text:"Close account"}].filter(x=>x)})}function wo({onAdd:n}){return e.jsx(j,{style:{color:w.tableText,backgroundColor:w.tableBackground,flex:1,alignItems:"center",borderTopWidth:1,borderColor:w.tableBorder},children:e.jsxs(j,{style:{width:550,marginTop:75,fontSize:15,alignItems:"center"},children:[e.jsxs(ee,{style:{textAlign:"center",lineHeight:"1.4em"},children:["For Actual to be useful, you need to ",e.jsx("strong",{children:"add an account"}),". You can link an account to automatically download transactions, or manage it locally yourself."]}),e.jsx(X,{variant:"primary",style:{marginTop:20},autoFocus:!0,onPress:n,children:"Add account"}),e.jsx(j,{style:{marginTop:20,fontSize:13,color:w.tableTextLight},children:"In the future, you can add accounts from the sidebar."})]})})}function bo({account:n={},transactions:t,balances:s,showBalances:a,filtered:i,children:r,collapseTransactions:c}){const o=n.id,l=Aa(c).map(x=>({...x,_inverse:o?o!==x.account:!1}));t??=[];let d=u.useMemo(()=>a&&s&&t?.length>0?s[t[0].id]?.balance??0:0,[a,s,t]);const p=u.useMemo(()=>{if(!a)return null;const x=[...l].reverse().map(T=>{const C=(T._inverse?-1:1)*nt(T.amount);return{balance:d+=C,id:T.id}});return xn(x)},[a,l,d]),g=u.useMemo(()=>!i&&l.length>0?l.concat(t):t,[i,l,t]),v=u.useMemo(()=>!i&&p&&s?{...p,...s}:s,[i,p,s]);return l?r(g,v):r(t,s)}function Kt(n){switch(n){case"account":return"account.name";case"payee":return"payee.name";case"category":return"category.name";case"payment":return"amount";case"deposit":return"amount";default:return n}}class So extends u.PureComponent{constructor(t){super(t),this.paged=null,this.table=u.createRef(),this.animated=!0,this.state={search:"",filterConditions:t.filterConditions||[],filterId:[],filterConditionsOp:"and",loading:!0,workingHard:!1,reconcileAmount:null,transactions:[],transactionsCount:0,showBalances:t.showBalances,balances:null,showCleared:t.showCleared,showReconciled:t.showReconciled,editingName:!1,isAdding:!1,latestDate:null,sort:[],filteredAmount:null}}async componentDidMount(){const t=i=>{if(i.includes("transactions")||i.includes("category_mapping")||i.includes("payee_mapping"))return this.refetchTransactions()},s=async({tables:i,messages:r})=>{await t(i);let c;if(r.every(o=>o.dataset==="transactions")&&!r.find(o=>o.column==="tombstone")){const o=r.filter(l=>l.dataset==="transactions"&&l.column!=="tombstone");c=o.length===1?o[0].row:null}this.table.current&&(this.table.current.edit(null),c&&this.table.current.scrollTo(c)),this.props.setLastUndoState(null)},a=[ft("undo-event",s)];this.unlisten=()=>{a.forEach(i=>i())},await this.props.initiallyLoadPayees(),await this.fetchTransactions(this.state.filterConditions),this.props.lastUndoState&&this.props.lastUndoState.current&&s(this.props.lastUndoState.current)}componentDidUpdate(t){this.state.isAdding&&this.props.accountId!==t.accountId&&this.setState({isAdding:!1}),t.modalShowing&&!this.props.modalShowing&&setTimeout(()=>{this.refetchTransactions()},100),this.props.accountId!==t.accountId&&this.setState({sort:[],search:"",filterConditions:[]})}componentWillUnmount(){this.unlisten&&this.unlisten(),this.paged&&this.paged.unsubscribe()}fetchAllIds=async()=>{const{data:t}=await ge(this.paged.getQuery().select("id"));return t.reduce((s,a)=>(s.push(a.id),a.subtransactions.forEach(i=>s.push(i.id)),s),[])};refetchTransactions=async()=>{this.paged?.run()};fetchTransactions=t=>{const s=this.makeRootQuery();this.rootQuery=this.currentQuery=s,t?this.applyFilters(t):this.updateQuery(s),this.props.accountId&&this.props.markAccountRead(this.props.accountId)};makeRootQuery=()=>{const t=this.props.accountId;return ya(t)};updateQuery(t,s){this.paged&&this.paged.unsubscribe(),this.state.showReconciled||(t=t.filter({reconciled:{$eq:!1}})),this.paged=wa(t.select("*"),async(a,i)=>{const r=i==null;r&&(this.table.current?.setRowAnimation(!1),s?this.props.splitsExpandedDispatch({type:"set-mode",mode:"collapse"}):this.props.splitsExpandedDispatch({type:"set-mode",mode:this.props.expandSplits?"expand":"collapse"})),this.setState({transactions:a,transactionCount:this.paged.getTotalCount(),transactionsFiltered:s,loading:!1,workingHard:!1,balances:this.state.showBalances?await this.calculateBalances():null,filteredAmount:await this.getFilteredAmount()},()=>{r&&this.table.current?.scrollToTop(),setTimeout(()=>{this.table.current?.setRowAnimation(!0)},0)})},{pageCount:150,onlySync:!0,mapper:Fe})}UNSAFE_componentWillReceiveProps(t){this.props.accountId!==t.accountId&&this.setState({editingName:!1,loading:!0,search:"",showBalances:t.showBalances,balances:null,showCleared:t.showCleared,showReconciled:t.showReconciled,reconcileAmount:null},()=>{this.fetchTransactions()})}onSearch=t=>{this.paged.unsubscribe(),this.setState({search:t},this.onSearchDone)};onSearchDone=ba.debounce(()=>{this.state.search===""?this.updateQuery(this.currentQuery,this.state.filterConditions.length>0):this.updateQuery(Sa(this.currentQuery,this.state.search,this.props.dateFormat),!0)},150);onSync=async()=>{const t=this.props.accountId,s=this.props.accounts.find(a=>a.id===t);await this.props.syncAndDownload(s?s.id:void 0)};onImport=async()=>{const t=this.props.accountId,s=this.props.accounts.find(i=>i.id===t),a=await this.props.getCategories();if(s){const i=await window.Actual?.openFileDialog({filters:[{name:"Financial Files",extensions:["qif","ofx","qfx","csv","tsv","xml"]}]});i&&this.props.pushModal("import-transactions",{accountId:t,categories:a,filename:i[0],onImported:r=>{r&&this.fetchTransactions()}})}};onExport=async t=>{const s=await Y("transactions-export-query",{query:this.currentQuery.serialize()}),i=`${t&&t.replace(/[()]/g,"").replace(/\s+/g,"-")||"transactions"}.csv`;window.Actual?.saveFile(s,i,"Export Transactions")};onTransactionsChange=(t,s)=>{this.paged.optimisticUpdate(a=>t._deleted?a.filter(i=>i.id!==t.id):a.map(i=>i.id===t.id?t:i),()=>s),this.props.updateNewTransactions(t.id)};canCalculateBalance=()=>{const t=this.props.accountId;return this.props.accounts.find(a=>a.id===t)&&this.state.search===""&&this.state.filterConditions.length===0&&(this.state.sort.length===0||this.state.sort.field==="date"&&this.state.sort.ascDesc==="desc")};async calculateBalances(){if(!this.canCalculateBalance())return null;const{data:t}=await ge(this.paged.getQuery().options({splits:"none"}).select([{balance:{$sumOver:"$amount"}}]));return xn(t)}onAddTransaction=()=>{this.setState({isAdding:!0})};onExposeName=t=>{this.setState({editingName:t})};onSaveName=t=>{if(t.trim().length){const s=this.props.accountId,a=this.props.accounts.find(i=>i.id===s);this.props.updateAccount({...a,name:t}),this.setState({editingName:!1})}};onToggleExtraBalances=()=>{const{accountId:t,showExtraBalances:s}=this.props,a="show-extra-balances-"+t||"all-accounts";this.props.savePrefs({[a]:!s})};onMenuSelect=async t=>{const s=this.props.accountId,a=this.props.accounts.find(i=>i.id===s);switch(t){case"link":this.props.pushModal("add-account",{upgradingAccountId:s});break;case"unlink":this.props.pushModal("confirm-unlink-account",{accountName:a.name,onUnlink:()=>{this.props.unlinkAccount(s)}});break;case"close":this.props.openAccountCloseModal(s);break;case"reopen":this.props.reopenAccount(s);break;case"export":const i=this.getAccountTitle(a,s);this.onExport(i);break;case"toggle-balance":this.state.showBalances?(this.props.savePrefs({["show-balances-"+s]:!1}),this.setState({showBalances:!1,balances:null})):(this.props.savePrefs({["show-balances-"+s]:!0}),this.setState({transactions:[],transactionCount:0,filterConditions:[],search:"",sort:[],showBalances:!0},()=>{this.fetchTransactions()}));break;case"remove-sorting":{this.setState({sort:[]},()=>{const r=this.state.filterConditions;r.length>0?this.applyFilters([...r]):this.fetchTransactions(),this.state.search!==""&&this.onSearch(this.state.search)});break}case"toggle-cleared":this.state.showCleared?(this.props.savePrefs({["hide-cleared-"+s]:!0}),this.setState({showCleared:!1})):(this.props.savePrefs({["hide-cleared-"+s]:!1}),this.setState({showCleared:!0}));break;case"toggle-reconciled":this.state.showReconciled?(this.props.savePrefs({["hide-reconciled-"+s]:!0}),this.setState({showReconciled:!1},()=>this.fetchTransactions(this.state.filterConditions))):(this.props.savePrefs({["hide-reconciled-"+s]:!1}),this.setState({showReconciled:!0},()=>this.fetchTransactions(this.state.filterConditions)));break}};getAccountTitle(t,s){const{filterName:a}=this.props.location.state||{};return a||(t?t.name:s==="budgeted"?"Budgeted Accounts":s==="offbudget"?"Off Budget Accounts":s==="uncategorized"?"Uncategorized":s?null:"All Accounts")}getBalanceQuery(t,s){return{name:`balance-query-${s}`,query:this.makeRootQuery().calculate({$sum:"$amount"})}}getFilteredAmount=async()=>{const{data:t}=await ge(this.paged.getQuery().calculate({$sum:"$amount"}));return t};isNew=t=>this.props.newTransactions.includes(t);isMatched=t=>this.props.matchedTransactions.includes(t);onCreatePayee=t=>t.trim()!==""?this.props.createPayee(t):null;lockTransactions=async()=>{this.setState({workingHard:!0});const{accountId:t}=this.props,{data:s}=await ge(we("transactions").filter({cleared:!0,reconciled:!1,account:t}).select("*").options({splits:"grouped"}));let a=Fe(s);const i={updated:[]};a.forEach(r=>{const{diff:c}=kt(a,{...r,reconciled:!0});a=fn(c,a),i.updated=i.updated?i.updated.concat(c.updated):c.updated}),await Y("transactions-batch-update",i),await this.refetchTransactions()};onReconcile=async t=>{this.setState(({showCleared:s})=>({reconcileAmount:t,showCleared:!0,prevShowCleared:s}))};onDoneReconciling=async()=>{const{accountId:t}=this.props,{reconcileAmount:s}=this.state,{data:a}=await ge(we("transactions").filter({cleared:!0,account:t}).select("*").options({splits:"grouped"})),i=Fe(a);let r=0;i.forEach(o=>{o.is_parent||(r+=o.amount)}),s-r===0&&await this.lockTransactions(),this.setState({reconcileAmount:null,showCleared:this.state.prevShowCleared})};onCreateReconciliationTransaction=async t=>{const s=hn([{id:"temp",account:this.props.accountId,cleared:!0,reconciled:!1,amount:t,date:At(),notes:"Reconciliation balance adjustment"}]);this.setState({transactions:[...s,...this.state.transactions]}),await Y("transactions-batch-update",{added:s}),await this.refetchTransactions()};onShowTransactions=async t=>{this.onApplyFilter({customName:"Selected transactions",queryFilter:{id:{$oneof:t}}})};onBatchEdit=(t,s)=>{this.props.onBatchEdit({name:t,ids:s,onSuccess:a=>{this.refetchTransactions(),this.table.current&&this.table.current.edit(a[0],"select",!1)}})};onBatchDuplicate=t=>{this.props.onBatchDuplicate({ids:t,onSuccess:this.refetchTransactions})};onBatchDelete=t=>{this.props.onBatchDelete({ids:t,onSuccess:this.refetchTransactions})};onMakeAsSplitTransaction=async t=>{this.setState({workingHard:!0});const{data:s}=await ge(we("transactions").filter({id:{$oneof:t}}).select("*").options({splits:"none"}));if(!s||s.length===0)return;const[a]=s,i={id:va(),is_parent:!0,cleared:s.every(c=>!!c.cleared),date:a.date,account:a.account,amount:s.map(c=>c.amount).reduce((c,o)=>c+o,0)},r=s.map(c=>ja(i,c));await Y("transactions-batch-update",{added:[i],updated:r}),this.refetchTransactions()};onMakeAsNonSplitTransactions=async t=>{this.setState({workingHard:!0});const{data:s}=await ge(we("transactions").filter({id:{$oneof:t}}).select("*").options({splits:"grouped"}));let a={updated:[],deleted:[]};const i=s.filter(c=>c.is_parent);for(const c of i){const o=Ca(c),[l,...d]=o;if(t.includes(l.id)){const v=Vt(d,o);a={updated:[...a.updated,...v.updated],deleted:[...a.deleted,...v.deleted]};continue}const p=d.filter(v=>t.includes(v.id));if(p.length===0)continue;const g=Vt(p,o);a={updated:[...a.updated,...g.updated],deleted:[...a.deleted,...g.deleted]}}await Y("transactions-batch-update",a),this.refetchTransactions();const r=a.updated.map(c=>c.id);this.dispatchSelected({type:"select-all",ids:r})};checkForReconciledTransactions=async(t,s,a)=>{const{data:i}=await ge(we("transactions").filter({id:{$oneof:t},reconciled:!0}).select("*").options({splits:"grouped"}));Fe(i).length>0?this.props.pushModal("confirm-transaction-edit",{onConfirm:()=>{a(t)},confirmReason:s}):a(t)};onBatchLinkSchedule=t=>{this.props.onBatchLinkSchedule({ids:t,account:this.props.accounts.find(s=>s.id===this.props.accountId),onSuccess:this.refetchTransactions})};onBatchUnlinkSchedule=t=>{this.props.onBatchUnlinkSchedule({ids:t,onSuccess:this.refetchTransactions})};onCreateRule=async t=>{const{data:s}=await ge(we("transactions").filter({id:{$oneof:t}}).select("*").options({splits:"grouped"})),a=Fe(s),i=a[0],r=a.filter(d=>d.parent_id===i.id),c=i.imported_payee?{field:"imported_payee",op:"is",value:i.imported_payee,type:"string"}:{field:"payee",op:"is",value:i.payee,type:"id"},o={field:"amount",op:"isapprox",value:i.amount,type:"number"},l={stage:null,conditionsOp:"and",conditions:[c,o],actions:[...r.length===0?[{op:"set",field:"category",value:i.category,type:"id",options:{splitIndex:0}}]:[],...r.flatMap((d,p)=>[{op:"set-split-amount",value:d.amount,options:{splitIndex:p+1,method:"fixed-amount"}},{op:"set",field:"category",value:d.category,type:"id",options:{splitIndex:p+1}}])]};this.props.pushModal("edit-rule",{rule:l})};onSetTransfer=async t=>{const s=async a=>{this.setState({workingHard:!0});const i=await this.props.getPayees(),{data:r}=await ge(we("transactions").filter({id:{$oneof:a}}).select("*")),[c,o]=r;if(r.length===2&&jn(c,o)){const l=i.find(g=>g.transfer_acct===c.account),d=i.find(g=>g.transfer_acct===o.account),p={updated:[{...c,payee:d.id,transfer_id:o.id},{...o,payee:l.id,transfer_id:c.id}]};await Y("transactions-batch-update",p)}await this.refetchTransactions()};await this.checkForReconciledTransactions(t,"batchEditWithReconciled",s)};onConditionsOpChange=t=>{this.setState({filterConditionsOp:t}),this.setState({filterId:{...this.state.filterId,status:"changed"}}),this.applyFilters([...this.state.filterConditions]),this.state.search!==""&&this.onSearch(this.state.search)};onReloadSavedFilter=(t,s)=>{if(s==="reload"){const[a]=this.props.savedFilters.filter(i=>i.id===this.state.filterId.id);this.setState({filterConditionsOp:a.conditionsOp}),this.applyFilters([...a.conditions])}else t.status&&(this.setState({filterConditionsOp:t.conditionsOp}),this.applyFilters([...t.conditions]));this.setState({filterId:{...this.state.filterId,...t}})};onClearFilters=()=>{this.setState({filterConditionsOp:"and"}),this.setState({filterId:[]}),this.applyFilters([]),this.state.search!==""&&this.onSearch(this.state.search)};onUpdateFilter=(t,s)=>{this.applyFilters(this.state.filterConditions.map(a=>a===t?s:a)),this.setState({filterId:{...this.state.filterId,status:this.state.filterId&&"changed"}}),this.state.search!==""&&this.onSearch(this.state.search)};onDeleteFilter=t=>{this.applyFilters(this.state.filterConditions.filter(s=>s!==t)),this.state.filterConditions.length===1?(this.setState({filterId:[]}),this.setState({filterConditionsOp:"and"})):this.setState({filterId:{...this.state.filterId,status:this.state.filterId&&"changed"}}),this.state.search!==""&&this.onSearch(this.state.search)};onApplyFilter=async t=>{let s=this.state.filterConditions;if(t.customName&&(s=s.filter(a=>a.customName!==t.customName)),t.conditions){const a=t;this.setState({filterId:{...a,status:"saved"}}),this.setState({filterConditionsOp:a.conditionsOp}),this.applyFilters([...a.conditions])}else{const a=t;this.setState({filterId:{...this.state.filterId,status:this.state.filterId&&"changed"}}),this.applyFilters([...s,a])}this.state.search!==""&&this.onSearch(this.state.search)};onScheduleAction=async(t,s)=>{switch(t){case"post-transaction":for(const a of s){const i=a.split("/");await Y("schedule/post-transaction",{id:i[1]})}this.refetchTransactions();break;case"skip":for(const a of s){const i=a.split("/");await Y("schedule/skip-next-date",{id:i[1]})}break}};applyFilters=async t=>{if(t.length>0){const s=t.filter(r=>!!r.customName).map(r=>r.queryFilter),{filters:a}=await Y("make-filters-from-conditions",{conditions:t.filter(r=>!r.customName)}),i=this.state.filterConditionsOp==="or"?"$or":"$and";this.currentQuery=this.rootQuery.filter({[i]:[...a,...s]}),this.setState({filterConditions:t},()=>{this.updateQuery(this.currentQuery,!0)})}else this.setState({transactions:[],transactionCount:0,filterConditions:t},()=>{this.fetchTransactions()});this.state.sort.length!==0&&this.applySort()};applySort=(t,s,a,i)=>{const r=this.state.filterConditions,c=r.length>0,o=Kt(t||this.state.sort.field),l=s||this.state.sort.ascDesc,d=Kt(a||this.state.sort.prevField),p=a?i:this.state.sort.prevAscDesc,g=function(T,C,h){C==="cleared"&&(T.currentQuery=T.currentQuery.orderBy({reconciled:h})),T.currentQuery=T.currentQuery.orderBy({[C]:h})},v=function(T,C,h){C==="cleared"?(T.currentQuery=T.rootQuery.orderBy({reconciled:h}),T.currentQuery=T.currentQuery.orderBy({cleared:h})):T.currentQuery=T.rootQuery.orderBy({[C]:h})},x=function(T,C,h){C&&(C==="cleared"&&(T.currentQuery=T.currentQuery.orderBy({reconciled:h})),T.currentQuery=T.currentQuery.orderBy({[C]:h}))};switch(!0){case!t:g(this,o,l);break;case c:this.applyFilters([...r]),g(this,o,l);break;case!c:v(this,o,l);break}x(this,d,p),this.updateQuery(this.currentQuery,c)};onSort=(t,s)=>{let a,i;t===this.state.sort.field?(a=this.state.sort.prevField,i=this.state.sort.prevAscDesc,this.setState({sort:{...this.state.sort,ascDesc:s}})):(a=this.state.sort.field,i=this.state.sort.ascDesc,this.setState({sort:{field:t,ascDesc:s,prevField:this.state.sort.field,prevAscDesc:this.state.sort.ascDesc}})),this.applySort(t,s,a,i),this.state.search!==""&&this.onSearch(this.state.search)};render(){const{accounts:t,categoryGroups:s,payees:a,dateFormat:i,hideFraction:r,addNotification:c,accountsSyncing:o,failedAccounts:l,replaceModal:d,showExtraBalances:p,accountId:g,categoryId:v}=this.props,{transactions:x,loading:T,workingHard:C,filterId:h,reconcileAmount:b,transactionsFiltered:R,editingName:M,showBalances:_,balances:L,showCleared:D,showReconciled:$,filteredAmount:E}=this.state,k=t.find(U=>U.id===g),P=this.getAccountTitle(k,g);if(!P&&!T)return e.jsx(Ta,{to:"/accounts",replace:!0});const O=s.flatMap(U=>U.categories).find(U=>U.id===v),H=!T&&!g&&t.length===0,q=g&&g!=="budgeted"&&g!=="offbudget"&&g!=="uncategorized",G=this.getBalanceQuery(k,g);return e.jsx(bo,{account:k,transactions:x,balances:L,showBalances:_,filtered:R,collapseTransactions:U=>this.props.splitsExpandedDispatch({type:"close-splits",ids:U}),children:(U,Z)=>e.jsx(ka,{name:"transactions",items:U,fetchAllIds:this.fetchAllIds,registerDispatch:m=>this.dispatchSelected=m,selectAllFilter:m=>!m._unmatched&&!m.is_parent,children:e.jsxs(j,{style:ce.page,children:[e.jsx(xo,{tableRef:this.table,editingName:M,isNameEditable:q,workingHard:C,account:k,filterId:h,savedFilters:this.props.savedFilters,location:this.props.location,accountName:P,accountsSyncing:o,failedAccounts:l,accounts:t,transactions:x,showBalances:_,showExtraBalances:p,showCleared:D,showReconciled:$,showEmptyMessage:H,balanceQuery:G,canCalculateBalance:this.canCalculateBalance,filteredAmount:E,isFiltered:R,isSorted:this.state.sort.length!==0,reconcileAmount:b,search:this.state.search,filterConditions:this.state.filterConditions,filterConditionsOp:this.state.filterConditionsOp,savePrefs:this.props.savePrefs,pushModal:this.props.pushModal,onSearch:this.onSearch,onShowTransactions:this.onShowTransactions,onMenuSelect:this.onMenuSelect,onAddTransaction:this.onAddTransaction,onToggleExtraBalances:this.onToggleExtraBalances,onSaveName:this.onSaveName,onExposeName:this.onExposeName,onReconcile:this.onReconcile,onDoneReconciling:this.onDoneReconciling,onCreateReconciliationTransaction:this.onCreateReconciliationTransaction,onSync:this.onSync,onImport:this.onImport,onBatchDelete:this.onBatchDelete,onBatchDuplicate:this.onBatchDuplicate,onBatchEdit:this.onBatchEdit,onBatchLinkSchedule:this.onBatchLinkSchedule,onBatchUnlinkSchedule:this.onBatchUnlinkSchedule,onCreateRule:this.onCreateRule,onUpdateFilter:this.onUpdateFilter,onClearFilters:this.onClearFilters,onReloadSavedFilter:this.onReloadSavedFilter,onConditionsOpChange:this.onConditionsOpChange,onDeleteFilter:this.onDeleteFilter,onApplyFilter:this.onApplyFilter,onScheduleAction:this.onScheduleAction,onSetTransfer:this.onSetTransfer,onMakeAsSplitTransaction:this.onMakeAsSplitTransaction,onMakeAsNonSplitTransactions:this.onMakeAsNonSplitTransactions}),e.jsx(j,{style:{flex:1},children:e.jsx(ao,{tableRef:this.table,account:k,transactions:x,allTransactions:U,animated:this.animated,loadMoreTransactions:()=>this.paged&&this.paged.fetchNext(),accounts:t,category:O,categoryGroups:s,payees:a,balances:Z,showBalances:!!Z,showCleared:D,showAccount:!g||g==="offbudget"||g==="budgeted"||g==="uncategorized",isAdding:this.state.isAdding,isNew:this.isNew,isMatched:this.isMatched,isFiltered:R,dateFormat:i,hideFraction:r,addNotification:c,renderEmpty:()=>H?e.jsx(wo,{onAdd:()=>d("add-account")}):T?null:e.jsx(j,{style:{color:w.tableText,marginTop:20,textAlign:"center",fontStyle:"italic"},children:"No transactions"}),onSort:this.onSort,sortField:this.state.sort.field,ascDesc:this.state.sort.ascDesc,onChange:this.onTransactionsChange,onRefetch:this.refetchTransactions,onRefetchUpToRow:m=>this.paged.refetchUpToRow(m,{field:"date",order:"desc"}),onCloseAddTransaction:()=>this.setState({isAdding:!1}),onCreatePayee:this.onCreatePayee,onApplyFilter:this.onApplyFilter})})]})})})}}function vo(n){const{dispatch:t}=Pt(),{onBatchEdit:s,onBatchDuplicate:a,onBatchLinkSchedule:i,onBatchUnlinkSchedule:r,onBatchDelete:c}=xa();return e.jsx(So,{splitsExpandedDispatch:t,onBatchEdit:s,onBatchDuplicate:a,onBatchLinkSchedule:i,onBatchUnlinkSchedule:r,onBatchDelete:c,...n})}function Ro(){const n=ca(),t=la(),{grouped:s}=jt(),a=Ee(D=>D.queries.newTransactions),i=Ee(D=>D.queries.matchedTransactions),r=da(),c=ua(),o=ha(),l=fa()||"MM/dd/yyyy",[d=!1]=Re("hideFraction"),[p]=Re("expand-splits"),[g]=Re(`show-balances-${n.id}`),[v]=Re(`hide-cleared-${n.id}`),[x]=Re(`hide-reconciled-${n.id}`),[T]=Re(`show-extra-balances-${n.id||"all-accounts"}`),C=Ee(D=>D.modals.modalStack.length>0),h=Ee(D=>D.account.accountsSyncing),b=Ee(D=>D.app.lastUndoState),R=t?.state?.filterConditions||[],M=pa(),_=nn(),L=ga(n.id);return e.jsx(ma,{transform:L,children:e.jsx(Za,{initialMode:p?"collapse":"expand",children:e.jsx(vo,{newTransactions:a,matchedTransactions:i,accounts:r,failedAccounts:o,dateFormat:l,hideFraction:d,expandSplits:p,showBalances:g,showCleared:!v,showReconciled:!x,showExtraBalances:T,payees:c,modalShowing:C,accountsSyncing:h,lastUndoState:b,filterConditions:R,categoryGroups:s,..._,accountId:n.id,categoryId:t?.state?.categoryId,location:t,savedFilters:M})})})}export{Ro as Account,Ro as Accounts,ko as Budget,Bo as GoCardlessLink,Ao as Schedules};
//# sourceMappingURL=wide.MXbklU4K.chunk.js.map
